#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Rubin AI v2 - Electrical Engineering API Server
–°–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–µ
"""

from flask import Flask, request, jsonify
from flask_cors import CORS
import json
import logging
from datetime import datetime
import os
import re
import xml.etree.ElementTree as ET
from io import BytesIO

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
try:
    from PIL import Image
    import numpy as np
    PIL_NUMPY_AVAILABLE = True
except Exception:
    PIL_NUMPY_AVAILABLE = False

# –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —É—Ç–∏–ª–∏—Ç
try:
    from electrical_utils import ElectricalUtils
    from electrical_knowledge_handler import ElectricalKnowledgeHandler
    ELECTRICAL_UTILS_AVAILABLE = True
    electrical_utils = ElectricalUtils()
    electrical_handler = ElectricalKnowledgeHandler()
except ImportError:
    ELECTRICAL_UTILS_AVAILABLE = False
    electrical_utils = None
    electrical_handler = None

app = Flask(__name__)
CORS(app, origins="*", methods=["GET", "POST", "OPTIONS"], allow_headers=["Content-Type", "Authorization"])

# –û–±—Ä–∞–±–æ—Ç–∫–∞ CORS preflight –∑–∞–ø—Ä–æ—Å–æ–≤
@app.before_request
def handle_preflight():
    if request.method == "OPTIONS":
        response = jsonify({})
        response.headers.add("Access-Control-Allow-Origin", "*")
        response.headers.add('Access-Control-Allow-Headers', "Content-Type,Authorization")
        response.headers.add('Access-Control-Allow-Methods', "GET,POST,OPTIONS")
        response.headers.add('Content-Type', 'application/json; charset=utf-8')
        return response

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤
@app.after_request
def after_request(response):
    if response.content_type == 'application/json':
        response.headers['Content-Type'] = 'application/json; charset=utf-8'
    return response

# –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø–æ —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–µ
ELECTRICAL_KNOWLEDGE = {
    "–¥–∏–æ–¥": {
        "title": "–î–∏–æ–¥",
        "description": "–ü–æ–ª—É–ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–≤—ã–π –ø—Ä–∏–±–æ—Ä, –ø—Ä–æ–ø—É—Å–∫–∞—é—â–∏–π —Ç–æ–∫ —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏",
        "explanation": """
**–î–∏–æ–¥ - —ç—Ç–æ –ø–æ–ª—É–ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–≤—ã–π –ø—Ä–∏–±–æ—Ä —Å –¥–≤—É–º—è —ç–ª–µ–∫—Ç—Ä–æ–¥–∞–º–∏:**

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
‚Ä¢ –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ç–æ–∫ —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ (–ø—Ä—è–º–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ)
‚Ä¢ –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–æ–∫ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ (–æ–±—Ä–∞—Ç–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ)
‚Ä¢ –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ p-n –ø–µ—Ä–µ—Ö–æ–¥–µ

**–¢–∏–ø—ã –¥–∏–æ–¥–æ–≤:**
‚Ä¢ –í—ã–ø—Ä—è–º–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∏–æ–¥—ã - –¥–ª—è –≤—ã–ø—Ä—è–º–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–∞
‚Ä¢ –°—Ç–∞–±–∏–ª–∏—Ç—Ä–æ–Ω—ã - –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
‚Ä¢ –°–≤–µ—Ç–æ–¥–∏–æ–¥—ã (LED) - –∏–∑–ª—É—á–∞—é—Ç —Å–≤–µ—Ç –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ —Ç–æ–∫–∞
‚Ä¢ –§–æ—Ç–æ–¥–∏–æ–¥—ã - –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç —Å–≤–µ—Ç –≤ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π —Ç–æ–∫

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
‚Ä¢ –ü—Ä—è–º–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ: 0.6-0.7–í (–∫—Ä–µ–º–Ω–∏–π), 0.2-0.3–í (–≥–µ—Ä–º–∞–Ω–∏–π)
‚Ä¢ –û–±—Ä–∞—Ç–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä—è–º–æ–π —Ç–æ–∫

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
‚Ä¢ –í—ã–ø—Ä—è–º–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–∞
‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–±—Ä–∞—Ç–Ω–æ–π –ø–æ–ª—è—Ä–Ω–æ—Å—Ç–∏
‚Ä¢ –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
‚Ä¢ –ò–Ω–¥–∏–∫–∞—Ü–∏—è (—Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã)
‚Ä¢ –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤
        """,
        "keywords": ["–¥–∏–æ–¥", "–ø–æ–ª—É–ø—Ä–æ–≤–æ–¥–Ω–∏–∫", "p-n –ø–µ—Ä–µ—Ö–æ–¥", "–≤—ã–ø—Ä—è–º–∏—Ç–µ–ª—å", "—Å—Ç–∞–±–∏–ª–∏—Ç—Ä–æ–Ω", "—Å–≤–µ—Ç–æ–¥–∏–æ–¥", "led"]
    },
    "–∑–∞–∫–æ–Ω –æ–º–∞": {
        "description": "–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–∫–æ–Ω —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∏, —Å–≤—è–∑—ã–≤–∞—é—â–∏–π –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Ç–æ–∫ –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ",
        "formula": "U = I √ó R",
        "explanation": """
**–ó–∞–∫–æ–Ω –û–º–∞ –¥–ª—è —É—á–∞—Å—Ç–∫–∞ —Ü–µ–ø–∏:**
‚Ä¢ U = I √ó R (–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ = —Ç–æ–∫ √ó —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ)
‚Ä¢ I = U / R (—Ç–æ–∫ = –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ / —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ)  
‚Ä¢ R = U / I (—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ = –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ / —Ç–æ–∫)

**–ó–∞–∫–æ–Ω –û–º–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π —Ü–µ–ø–∏:**
‚Ä¢ I = E / (R + r)
‚Ä¢ E - –≠–î–° –∏—Å—Ç–æ—á–Ω–∏–∫–∞
‚Ä¢ R - –≤–Ω–µ—à–Ω–µ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
‚Ä¢ r - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
‚Ä¢ –†–∞—Å—á–µ—Ç —Ç–æ–∫–æ–≤ –≤ —Ü–µ–ø—è—Ö
‚Ä¢ –í—ã–±–æ—Ä —Ä–µ–∑–∏—Å—Ç–æ—Ä–æ–≤
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ü–µ–ø–µ–π –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ç–æ–∫–∞
        """,
        "examples": [
            "–ü—Ä–∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–∏ 12–í –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–∏ 4–û–º —Ç–æ–∫ = 12/4 = 3–ê",
            "–ü—Ä–∏ —Ç–æ–∫–µ 2–ê –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–∏ 6–û–º –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ = 2√ó6 = 12–í"
        ]
    },
    
    "–∑–∞–∫–æ–Ω –∫–∏—Ä—Ö–≥–æ—Ñ–∞": {
        "title": "–ó–∞–∫–æ–Ω—ã –ö–∏—Ä—Ö–≥–æ—Ñ–∞",
        "description": "–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫–æ–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–ø–µ–π",
        "explanation": """
**–ü–µ—Ä–≤—ã–π –∑–∞–∫–æ–Ω –ö–∏—Ä—Ö–≥–æ—Ñ–∞ (–∑–∞–∫–æ–Ω —Ç–æ–∫–æ–≤):**
‚Ä¢ –°—É–º–º–∞ —Ç–æ–∫–æ–≤, –≤—Ö–æ–¥—è—â–∏—Ö –≤ —É–∑–µ–ª = —Å—É–º–º–µ —Ç–æ–∫–æ–≤, –≤—ã—Ö–æ–¥—è—â–∏—Ö –∏–∑ —É–∑–ª–∞
‚Ä¢ Œ£I–≤—Ö = Œ£I–≤—ã—Ö

**–í—Ç–æ—Ä–æ–π –∑–∞–∫–æ–Ω –ö–∏—Ä—Ö–≥–æ—Ñ–∞ (–∑–∞–∫–æ–Ω –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π):**
‚Ä¢ –°—É–º–º–∞ –≠–î–° –≤ –∑–∞–º–∫–Ω—É—Ç–æ–º –∫–æ–Ω—Ç—É—Ä–µ = —Å—É–º–º–µ –ø–∞–¥–µ–Ω–∏–π –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π
‚Ä¢ Œ£E = Œ£(I√óR)

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ü–µ–ø–µ–π
‚Ä¢ –†–∞—Å—á–µ—Ç —Ç–æ–∫–æ–≤ –≤ —Ä–∞–∑–≤–µ—Ç–≤–ª–µ–Ω–Ω—ã—Ö —Ü–µ–ø—è—Ö
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç–æ–≤
        """,
        "examples": [
            "–í —É–∑–ª–µ: I1 + I2 = I3 + I4",
            "–í –∫–æ–Ω—Ç—É—Ä–µ: E1 - E2 = I1√óR1 + I2√óR2"
        ]
    },
    
    "–º–æ—â–Ω–æ—Å—Ç—å": {
        "title": "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞—è –º–æ—â–Ω–æ—Å—Ç—å",
        "description": "–ú–æ—â–Ω–æ—Å—Ç—å –≤ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–ø—è—Ö",
        "formula": "P = U √ó I = I¬≤ √ó R = U¬≤ / R",
        "explanation": """
**–§–æ—Ä–º—É–ª—ã –º–æ—â–Ω–æ—Å—Ç–∏ (–æ–¥–Ω–æ—Ñ–∞–∑–Ω–∞—è —Ü–µ–ø—å):**
‚Ä¢ P = U √ó I (–º–æ—â–Ω–æ—Å—Ç—å = –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ √ó —Ç–æ–∫)
‚Ä¢ P = I¬≤ √ó R (–º–æ—â–Ω–æ—Å—Ç—å = —Ç–æ–∫¬≤ √ó —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ)
‚Ä¢ P = U¬≤ / R (–º–æ—â–Ω–æ—Å—Ç—å = –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ¬≤ / —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ)

**–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è:**
‚Ä¢ –í–∞—Ç—Ç (–í—Ç) - –æ—Å–Ω–æ–≤–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞
‚Ä¢ –ö–∏–ª–æ–≤–∞—Ç—Ç (–∫–í—Ç) = 1000 –í—Ç
‚Ä¢ –ú–µ–≥–∞–≤–∞—Ç—Ç (–ú–í—Ç) = 1000000 –í—Ç

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
‚Ä¢ –†–∞—Å—á–µ—Ç –ø–æ—Ç—Ä–µ–±–ª—è–µ–º–æ–π –º–æ—â–Ω–æ—Å—Ç–∏
‚Ä¢ –í—ã–±–æ—Ä –ø—Ä–æ–≤–æ–¥–æ–≤ –∏ –∑–∞—â–∏—Ç–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚Ä¢ –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—á–µ—Ç—ã
        """
    },
    
    "—Ç—Ä–µ—Ö—Ñ–∞–∑–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å": {
        "title": "–ú–æ—â–Ω–æ—Å—Ç—å –≤ —Ç—Ä–µ—Ö—Ñ–∞–∑–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ",
        "description": "–†–∞—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π, —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π –∏ –ø–æ–ª–Ω–æ–π –º–æ—â–Ω–æ—Å—Ç–∏ –≤ —Ç—Ä–µ—Ö—Ñ–∞–∑–Ω—ã—Ö —Ü–µ–ø—è—Ö",
        "explanation": """
**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã:**
*   **U–ª** - –õ–∏–Ω–µ–π–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ (–º–µ–∂–¥—É –¥–≤—É–º—è —Ñ–∞–∑–∞–º–∏).
*   **U—Ñ** - –§–∞–∑–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ (–º–µ–∂–¥—É —Ñ–∞–∑–æ–π –∏ –Ω–µ–π—Ç—Ä–∞–ª—å—é).
*   **I–ª** - –õ–∏–Ω–µ–π–Ω—ã–π —Ç–æ–∫ (–≤ –ª–∏–Ω–∏–∏).
*   **I—Ñ** - –§–∞–∑–Ω—ã–π —Ç–æ–∫ (–≤ —Ñ–∞–∑–µ –Ω–∞–≥—Ä—É–∑–∫–∏).
*   **cos(œÜ)** - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–æ—â–Ω–æ—Å—Ç–∏.

**1. –ê–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å (P, –∏–∑–º–µ—Ä—è–µ—Ç—Å—è –≤ –í–∞—Ç—Ç–∞—Ö, –í—Ç):**
–≠—Ç–æ –ø–æ–ª–µ–∑–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∞–±–æ—Ç—É.
*   `P = 3 * U—Ñ * I—Ñ * cos(œÜ)`
*   `P = ‚àö3 * U–ª * I–ª * cos(œÜ)` (–Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–∞—è —Ñ–æ—Ä–º—É–ª–∞)

**2. –†–µ–∞–∫—Ç–∏–≤–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å (Q, –∏–∑–º–µ—Ä—è–µ—Ç—Å—è –≤ –í–æ–ª—å—Ç-–ê–º–ø–µ—Ä–∞—Ö —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö, –≤–∞—Ä):**
–≠—Ç–æ –º–æ—â–Ω–æ—Å—Ç—å, –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–Ω–∏—Ç–Ω—ã—Ö –ø–æ–ª–µ–π –≤ –¥–≤–∏–≥–∞—Ç–µ–ª—è—Ö –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä–∞—Ö.
*   `Q = 3 * U—Ñ * I—Ñ * sin(œÜ)`
*   `Q = ‚àö3 * U–ª * I–ª * sin(œÜ)`

**3. –ü–æ–ª–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å (S, –∏–∑–º–µ—Ä—è–µ—Ç—Å—è –≤ –í–æ–ª—å—Ç-–ê–º–ø–µ—Ä–∞—Ö, –í–ê):**
–≠—Ç–æ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –∏ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π –º–æ—â–Ω–æ—Å—Ç–µ–π.
*   `S = 3 * U—Ñ * I—Ñ`
*   `S = ‚àö3 * U–ª * I–ª`
*   `S = ‚àö(P¬≤ + Q¬≤)`
        """
    },
    
    "—Ä–µ–∑–∏—Å—Ç–æ—Ä": {
        "title": "–†–µ–∑–∏—Å—Ç–æ—Ä—ã",
        "description": "–ü–∞—Å—Å–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–µ —Ç–æ–∫ –≤ —Ü–µ–ø–∏",
        "explanation": """
**–¢–∏–ø—ã —Ä–µ–∑–∏—Å—Ç–æ—Ä–æ–≤:**
‚Ä¢ –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
‚Ä¢ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø–æ—Ç–µ–Ω—Ü–∏–æ–º–µ—Ç—Ä—ã) - —Ä–µ–≥—É–ª–∏—Ä—É–µ–º–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
‚Ä¢ –¢–µ—Ä–º–∏—Å—Ç–æ—Ä—ã - —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã

**–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞:**
‚Ä¢ –¶–≤–µ—Ç–æ–≤–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞ (4-6 –ø–æ–ª–æ—Å)
‚Ä¢ –¶–∏—Ñ—Ä–æ–≤–∞—è –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞
‚Ä¢ SMD –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞

**–°–æ–µ–¥–∏–Ω–µ–Ω–∏—è:**
‚Ä¢ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ: R–æ–±—â = R1 + R2 + R3
‚Ä¢ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ: 1/R–æ–±—â = 1/R1 + 1/R2 + 1/R3
        """
    },
    
    "–∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä": {
        "title": "–ö–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä—ã",
        "description": "–≠–ª–µ–º–µ–Ω—Ç—ã, –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—â–∏–µ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π –∑–∞—Ä—è–¥",
        "explanation": """
**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
‚Ä¢ –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∑–∞—Ä—è–¥–∞ –Ω–∞ –æ–±–∫–ª–∞–¥–∫–∞—Ö
‚Ä¢ –ï–º–∫–æ—Å—Ç—å C = Q / U
‚Ä¢ –≠–Ω–µ—Ä–≥–∏—è W = C √ó U¬≤ / 2

**–¢–∏–ø—ã –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–æ–≤:**
‚Ä¢ –ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ - –º–∞–ª—ã–µ —Ä–∞–∑–º–µ—Ä—ã, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
‚Ä¢ –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ - –±–æ–ª—å—à–∞—è –µ–º–∫–æ—Å—Ç—å
‚Ä¢ –ü–ª–µ–Ω–æ—á–Ω—ã–µ - –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
‚Ä¢ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
‚Ä¢ –†–∞–∑–≤—è–∑–∫–∞ —Ü–µ–ø–µ–π
‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏
        """
    },
    
    "modbus": {
        "title": "–ü—Ä–æ—Ç–æ–∫–æ–ª Modbus",
        "description": "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª —Å–≤—è–∑–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏",
        "explanation": """
**Modbus RTU:**
‚Ä¢ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Å–≤—è–∑—å (RS-485, RS-232)
‚Ä¢ –ë–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ CRC –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞
‚Ä¢ –ê–¥—Ä–µ—Å–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (1-247)

**–§—É–Ω–∫—Ü–∏–∏ Modbus:**
‚Ä¢ 01 - –ß—Ç–µ–Ω–∏–µ –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã—Ö –≤—ã—Ö–æ–¥–æ–≤
‚Ä¢ 02 - –ß—Ç–µ–Ω–∏–µ –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã—Ö –≤—Ö–æ–¥–æ–≤  
‚Ä¢ 03 - –ß—Ç–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è
‚Ä¢ 04 - –ß—Ç–µ–Ω–∏–µ –≤—Ö–æ–¥–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
‚Ä¢ 05 - –ó–∞–ø–∏—Å—å –æ–¥–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞
‚Ä¢ 06 - –ó–∞–ø–∏—Å—å –æ–¥–Ω–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–¥—Ä–∞:**
‚Ä¢ –ê–¥—Ä–µ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (1 –±–∞–π—Ç)
‚Ä¢ –ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ (1 –±–∞–π—Ç)
‚Ä¢ –î–∞–Ω–Ω—ã–µ (N –±–∞–π—Ç)
‚Ä¢ CRC (2 –±–∞–π—Ç–∞)

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
‚Ä¢ PLC —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ SCADA —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ —Å–µ—Ç–∏
        """
    },
    "—à–∏–º": {
        "title": "–®–ò–ú (–®–∏—Ä–æ—Ç–Ω–æ-–∏–º–ø—É–ª—å—Å–Ω–∞—è –º–æ–¥—É–ª—è—Ü–∏—è)",
        "description": "–ú–µ—Ç–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ—â–Ω–æ—Å—Ç—å—é –∏ —Å–∫–æ—Ä–æ—Å—Ç—å—é —ç–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª–µ–π",
        "explanation": """
**–®–ò–ú (–®–∏—Ä–æ—Ç–Ω–æ-–∏–º–ø—É–ª—å—Å–Ω–∞—è –º–æ–¥—É–ª—è—Ü–∏—è):**

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
‚Ä¢ **–ò–º–ø—É–ª—å—Å—ã** - –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —à–∏—Ä–∏–Ω—ã
‚Ä¢ **–ß–∞—Å—Ç–æ—Ç–∞** - –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
‚Ä¢ **–°–∫–≤–∞–∂–Ω–æ—Å—Ç—å** - –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–µ—Ä–∏–æ–¥—É
‚Ä¢ **–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ** - –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å–∫–≤–∞–∂–Ω–æ—Å—Ç–∏

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –®–ò–ú:**
‚Ä¢ **–ß–∞—Å—Ç–æ—Ç–∞** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–º–ø—É–ª—å—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É (–ì—Ü)
‚Ä¢ **–°–∫–≤–∞–∂–Ω–æ—Å—Ç—å** - –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–µ—Ä–∏–æ–¥—É (%)
‚Ä¢ **–ê–º–ø–ª–∏—Ç—É–¥–∞** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
‚Ä¢ **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ** - —Ç–æ—á–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–≤–∞–∂–Ω–æ—Å—Ç–∏

**–¢–∏–ø—ã –®–ò–ú:**
‚Ä¢ **–ê–Ω–∞–ª–æ–≥–æ–≤–∞—è** - –ø–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∫–≤–∞–∂–Ω–æ—Å—Ç–∏
‚Ä¢ **–¶–∏—Ñ—Ä–æ–≤–∞—è** - –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–∫–≤–∞–∂–Ω–æ—Å—Ç–∏
‚Ä¢ **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º —Å–∏–≥–Ω–∞–ª–æ–º
‚Ä¢ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è** - –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è —á–∞—Å—Ç–æ—Ç–∞

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
‚Ä¢ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–≥–∞—Ç–µ–ª—è–º–∏** - —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
‚Ä¢ **–°—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä—ã –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è** - –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
‚Ä¢ **–ò–Ω–≤–µ—Ä—Ç–æ—Ä—ã** - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ç–æ–∫–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–π
‚Ä¢ **–ó–∞—Ä—è–¥–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–æ–º –∑–∞—Ä—è–¥–∫–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –®–ò–ú:**
‚Ä¢ **–í—ã—Å–æ–∫–∏–π –ö–ü–î** - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–æ—Ç–µ—Ä–∏ –º–æ—â–Ω–æ—Å—Ç–∏
‚Ä¢ **–ü–ª–∞–≤–Ω–æ–µ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ç–æ—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
‚Ä¢ **–ö–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—å** - –º–∞–ª—ã–µ —Ä–∞–∑–º–µ—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚Ä¢ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
‚Ä¢ **–≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–µ –ø–æ–º–µ—Ö–∏** - –≤—ã—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
‚Ä¢ **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏** - –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
‚Ä¢ **–ù–∞–≥—Ä–µ–≤ –∫–ª—é—á–µ–π** - –ø–æ—Ç–µ—Ä–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
‚Ä¢ **–°—Ç–æ–∏–º–æ—Å—Ç—å** - —Å–ª–æ–∂–Ω–∞—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞

**–ü–ª–∞—Ç–∞ –®–ò–ú:**
‚Ä¢ **–ú–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –®–ò–ú —Å–∏–≥–Ω–∞–ª–æ–≤
‚Ä¢ **–î—Ä–∞–π–≤–µ—Ä—ã** - —É—Å–∏–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
‚Ä¢ **–ö–ª—é—á–∏** - —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä—ã –∏–ª–∏ MOSFET
‚Ä¢ **–§–∏–ª—å—Ç—Ä—ã** - —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
‚Ä¢ **–ó–∞—â–∏—Ç–∞** - –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–æ–∫ –∏ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–º—ã–∫–∞–Ω–∏–π

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –®–ò–ú:**
‚Ä¢ **–ß–∞—Å—Ç–æ—Ç–∞** - –≤—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–æ—Ç—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
‚Ä¢ **–°–∫–≤–∞–∂–Ω–æ—Å—Ç—å** - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—Ä–µ–±—É–µ–º–æ–π –º–æ—â–Ω–æ—Å—Ç–∏
‚Ä¢ **–ó–∞—â–∏—Ç–∞** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–∫–æ–≤–æ–π –∑–∞—â–∏—Ç—ã
‚Ä¢ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –ø–æ–¥–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞
        """
    },
    "—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä": {
        "title": "–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä",
        "description": "–≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è",
        "formula": "U1/U2 = N1/N2",
        "explanation": """
**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä–∞:**

**–û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:**
‚Ä¢ **–ü–µ—Ä–≤–∏—á–Ω–∞—è –æ–±–º–æ—Ç–∫–∞** - –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –ø–∏—Ç–∞–Ω–∏—è
‚Ä¢ **–í—Ç–æ—Ä–∏—á–Ω–∞—è –æ–±–º–æ—Ç–∫–∞** - –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ –Ω–∞–≥—Ä—É–∑–∫–µ
‚Ä¢ **–ú–∞–≥–Ω–∏—Ç–æ–ø—Ä–æ–≤–æ–¥** - —Å–µ—Ä–¥–µ—á–Ω–∏–∫ –∏–∑ —Ñ–µ—Ä—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
‚Ä¢ **–ò–∑–æ–ª—è—Ü–∏—è** - –º–µ–∂–¥—É –æ–±–º–æ—Ç–∫–∞–º–∏ –∏ —Å–µ—Ä–¥–µ—á–Ω–∏–∫–æ–º

**–ü—Ä–∏–Ω—Ü–∏–ø –¥–µ–π—Å—Ç–≤–∏—è:**
‚Ä¢ **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫** –≤ –ø–µ—Ä–≤–∏—á–Ω–æ–π –æ–±–º–æ—Ç–∫–µ —Å–æ–∑–¥–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–µ –º–∞–≥–Ω–∏—Ç–Ω–æ–µ –ø–æ–ª–µ
‚Ä¢ **–ú–∞–≥–Ω–∏—Ç–Ω–æ–µ –ø–æ–ª–µ** –ø—Ä–æ–Ω–∏–∑—ã–≤–∞–µ—Ç –≤—Ç–æ—Ä–∏—á–Ω—É—é –æ–±–º–æ—Ç–∫—É
‚Ä¢ **–≠–î–° –∏–Ω–¥—É–∫—Ü–∏–∏** –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤–æ –≤—Ç–æ—Ä–∏—á–Ω–æ–π –æ–±–º–æ—Ç–∫–µ
‚Ä¢ **–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ** –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–∏—Ç–∫–æ–≤

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã:**
‚Ä¢ **–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏:** k = U1/U2 = N1/N2
‚Ä¢ **–ú–æ—â–Ω–æ—Å—Ç—å:** P1 ‚âà P2 (–∏–¥–µ–∞–ª—å–Ω—ã–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä)
‚Ä¢ **–¢–æ–∫:** I1/I2 = N2/N1 = 1/k

**–¢–∏–ø—ã —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä–æ–≤:**
‚Ä¢ **–ü–æ–≤—ã—à–∞—é—â–∏–π** - U2 > U1, N2 > N1
‚Ä¢ **–ü–æ–Ω–∏–∂–∞—é—â–∏–π** - U2 < U1, N2 < N1
‚Ä¢ **–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã–π** - U1 = U2, N1 = N2
‚Ä¢ **–ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä** - –æ–±—â–∞—è –æ–±–º–æ—Ç–∫–∞

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
‚Ä¢ **–≠–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ** - –ø–µ—Ä–µ–¥–∞—á–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏
‚Ä¢ **–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞** - –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∏—Ç–∞–Ω–∏—è
‚Ä¢ **–ò–∑–º–µ—Ä–µ–Ω–∏—è** - –∏–∑–º–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä—ã
‚Ä¢ **–°–≤–∞—Ä–∫–∞** - —Å–≤–∞—Ä–æ—á–Ω—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä—ã

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
‚Ä¢ **–ù–æ–º–∏–Ω–∞–ª—å–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å
‚Ä¢ **–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏** - –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π
‚Ä¢ **–ö–ü–î** - –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–Ω–æ–π –º–æ—â–Ω–æ—Å—Ç–∏ –∫ –≤—Ö–æ–¥–Ω–æ–π
‚Ä¢ **–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –∑–∞–º—ã–∫–∞–Ω–∏—è** - —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –∑–∞—â–∏—Ç—ã
        """
    }
}


# === –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≥—Ä–∞—Ñ–∏–∫–æ–≤ ===
@app.route('/api/graph/import_xml', methods=['POST'])
def import_graph_from_xml():
    """–ò–º–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑ XML-—Ñ–∞–π–ª–∞.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç:
      - multipart/form-data —Å –∫–ª—é—á–æ–º 'file' (–∑–∞–≥—Ä—É–∑–∫–∞ XML)
      - –∏–ª–∏ JSON —Å –ø–æ–ª–µ–º 'file_path' (–ø—É—Ç—å –∫ XML –Ω–∞ –¥–∏—Å–∫–µ)

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ (x,y) –∏ –±–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏. –ï—Å–ª–∏ —è–≤–Ω–æ–π –æ—Å–∏ X –Ω–µ—Ç,
    –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å —Ç–æ—á–∫–∏ –≤ –∫–∞—á–µ—Å—Ç–≤–µ X.
    """
    try:
        raw_xml = None

        # 1) –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ multipart
        if 'file' in request.files:
            f = request.files['file']
            raw_xml = f.read()
        else:
            # 2) –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ JSON –ø–æ file_path
            data = request.get_json(silent=True) or {}
            file_path = data.get('file_path') or request.form.get('file_path')
            if file_path:
                if not os.path.isfile(file_path):
                    return jsonify({'success': False, 'error': f'–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}'}), 400
                with open(file_path, 'rb') as fh:
                    raw_xml = fh.read()

        if not raw_xml:
            return jsonify({'success': False, 'error': '–ù–µ –ø–µ—Ä–µ–¥–∞–Ω —Ñ–∞–π–ª XML –Ω–∏ —á–µ—Ä–µ–∑ form-data (file), –Ω–∏ —á–µ—Ä–µ–∑ file_path'}), 400

        # –ü–∞—Ä—Å–∏–º XML
        try:
            root = ET.fromstring(raw_xml)
        except Exception as e:
            return jsonify({'success': False, 'error': f'–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π XML: {e}'}), 400

        # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å —á–∏—Å–µ–ª
        def extract_floats(text: str):
            if not text:
                return []
            nums = re.findall(r"[-+]?\d*\.?\d+(?:[eE][-+]?\d+)?", text)
            try:
                return [float(x) for x in nums]
            except Exception:
                return []

        points = []  # –°–ø–∏—Å–æ–∫ [x, y]
        xs, ys = [], []

        # –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:
        # A) –ò—â–µ–º —É–∑–ª—ã —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ x/y
        for elem in root.iter():
            x_attr = elem.attrib.get('x')
            y_attr = elem.attrib.get('y')
            if x_attr is not None and y_attr is not None:
                try:
                    x_val = float(x_attr)
                    y_val = float(y_attr)
                    points.append([x_val, y_val])
                except Exception:
                    pass

        # B) –ï—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω—ã—Ö —Ç–æ—á–µ–∫, –ø—Ä–æ–±—É–µ–º —Å–æ–±—Ä–∞—Ç—å –º–∞—Å—Å–∏–≤—ã X/Y –∏–∑ —Ç–µ–≥–æ–≤
        if not points:
            # –ß–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è –Ω–∞–∑–≤–∞–Ω–∏—è
            x_tags = ['x', 'xs', 'time', 't']
            y_tags = ['y', 'ys', 'value', 'val', 'position', 'pos', 'z', 'data']

            # –°–æ–±–µ—Ä—ë–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ —Ç–µ–∫—Å—Ç—É
            def collect_series_by_tags(tag_names):
                series = []
                for tn in tag_names:
                    for elem in root.iter():
                        if elem.tag.lower().endswith(tn):
                            vals = extract_floats((elem.text or '').strip())
                            if vals:
                                series.append(vals)
                return series

            x_series = collect_series_by_tags(x_tags)
            y_series = collect_series_by_tags(y_tags)

            # –í—ã–±–∏—Ä–∞–µ–º —Å–∞–º—É—é –¥–ª–∏–Ω–Ω—É—é —Å–µ—Ä–∏—é X –∏ Y
            best_x = max(x_series, key=len) if x_series else []
            best_y = max(y_series, key=len) if y_series else []

            if best_y and best_x and len(best_x) == len(best_y):
                points = [[best_x[i], best_y[i]] for i in range(len(best_y))]
            elif best_y:
                points = [[i, best_y[i]] for i in range(len(best_y))]

        # C) –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –ø—É—Å—Ç–æ ‚Äì –ø—Ä–æ–±—É–µ–º –ø–æ —É–∑–ª–∞–º <point>—á–∏—Å–ª–æ —á–∏—Å–ª–æ</point>
        if not points:
            for elem in root.iter():
                vals = extract_floats((elem.text or '').strip())
                if len(vals) >= 2:
                    # –ë–µ—Ä—ë–º –ø–æ–ø–∞—Ä–Ω–æ
                    for i in range(0, len(vals) - 1, 2):
                        points.append([vals[i], vals[i+1]])
            # –ï—Å–ª–∏ —Å–æ–±—Ä–∞–ª–∏ –Ω–µ—á—ë—Ç–Ω–æ/–º–∞–ª–æ, fallback –ø–æ –æ–¥–Ω–æ–º—É –º–∞—Å—Å–∏–≤—É
            if len(points) < 5:
                flat_vals = []
                for elem in root.iter():
                    flat_vals.extend(extract_floats((elem.text or '').strip()))
                if len(flat_vals) >= 5:
                    points = [[i, v] for i, v in enumerate(flat_vals)]

        if not points:
            return jsonify({'success': False, 'error': '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–æ—á–∫–∏ –∏–∑ XML (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)'}), 400

        # –ú–µ—Ç—Ä–∏–∫–∏
        import numpy as _np
        arr = _np.array(points, dtype=_np.float64)
        xs = arr[:, 0]
        ys = arr[:, 1]
        n = len(points)
        try:
            # –õ–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è y ~ a*x + b
            A = _np.vstack([xs, _np.ones_like(xs)]).T
            a, b = _np.linalg.lstsq(A, ys, rcond=None)[0]
        except Exception:
            a, b = 0.0, float(_np.mean(ys))

        summary = {
            'points_count': int(n),
            'x_min': float(_np.min(xs)), 'x_max': float(_np.max(xs)),
            'y_min': float(_np.min(ys)), 'y_max': float(_np.max(ys)),
            'y_mean': float(_np.mean(ys)), 'y_std': float(_np.std(ys)),
            'trend_slope': float(a), 'trend_intercept': float(b)
        }

        # –û–≥—Ä–∞–Ω–∏—á–∏–º –≤—ã–¥–∞—á—É —Ç–æ—á–µ–∫ (–¥–æ 5000)
        max_pts = 5000
        pts_out = points if n <= max_pts else points[:: max(1, n // max_pts)]

        return jsonify({
            'success': True,
            'service': 'Electrical API',
            'source': 'xml',
            'points': pts_out,
            'summary': summary,
            'timestamp': datetime.now().isoformat()
        })

    except Exception as e:
        logging.exception('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ XML –≥—Ä–∞—Ñ–∏–∫–∞')
        return jsonify({'success': False, 'error': str(e)}), 500
@app.route('/api/graph/analyze', methods=['POST'])
def analyze_graph_image():
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç PNG/JPG –≥—Ä–∞—Ñ–∏–∫–∞, –∏–∑–≤–ª–µ–∫–∞–µ—Ç –±–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏."""
    try:
        if not PIL_NUMPY_AVAILABLE:
            return jsonify({
                'success': False,
                'error': '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Pillow/Numpy –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.'
            }), 500

        if 'file' not in request.files:
            return jsonify({
                'success': False,
                'error': '–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –∫–ª—é—á–æ–º form-data "file"'
            }), 400

        file = request.files['file']
        raw = file.read()
        if not raw:
            return jsonify({'success': False, 'error': '–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª'}), 400

        # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≥—Ä–∞–¥–∞—Ü–∏—è—Ö —Å–µ—Ä–æ–≥–æ
        img = Image.open(BytesIO(raw)).convert('L')
        arr = np.asarray(img, dtype=np.float32)
        h, w = arr.shape

        # –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
        mean_val = float(np.mean(arr))
        std_val = float(np.std(arr))

        # –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –ø–æ –æ—Å—è–º –¥–ª—è –æ—Ü–µ–Ω–∫–∏ "—Ä–µ–∑–∫–æ—Å—Ç–∏"/–Ω–∞–ª–∏—á–∏—è –ª–∏–Ω–∏–π
        gx = np.abs(np.diff(arr, axis=1))
        gy = np.abs(np.diff(arr, axis=0))
        edge_strength = float(np.mean(gx) + np.mean(gy))

        # –û—Ü–µ–Ω–∫–∞ —Ç—Ä–µ–Ω–¥–∞ –ø–æ —Å—Ä–µ–¥–Ω–µ–π —è—Ä–∫–æ—Å—Ç–∏ –∫–æ–ª–æ–Ω–æ–∫ (–ø—Ä–æ—Å—Ç–∞—è –ª–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è)
        col_mean = np.mean(arr, axis=0)
        x = np.arange(col_mean.shape[0], dtype=np.float32)
        # np.polyfit –º–æ–∂–µ—Ç –±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ NaN ‚Äî –∑–∞—â–∏—Ç–∏–º—Å—è
        try:
            slope = float(np.polyfit(x, col_mean, 1)[0])
        except Exception:
            slope = 0.0

        # –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        recs = []
        if edge_strength < 1.0:
            recs.append('–ù–∏–∑–∫–∞—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å –ª–∏–Ω–∏–π ‚Äî —É–≤–µ–ª–∏—á—å—Ç–µ —Ç–æ–ª—â–∏–Ω—É/–∫–æ–Ω—Ç—Ä–∞—Å—Ç –∫—Ä–∏–≤—ã—Ö –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ.')
        else:
            recs.append('–ö–æ–Ω—Ç—É—Ä—ã –≥—Ä–∞—Ñ–∏–∫–∞ —á–∏—Ç–∞–µ–º—ã ‚Äî –º–æ–∂–Ω–æ –∏–∑–≤–ª–µ–∫–∞—Ç—å —Ç–æ—á–∫–∏ –¥–ª—è —á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.')

        if abs(slope) > 0.01:
            recs.append('–ù–∞–±–ª—é–¥–∞–µ—Ç—Å—è –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–π —Ç—Ä–µ–Ω–¥ ‚Äî –æ—Ü–µ–Ω–∏—Ç–µ –Ω–∞–∫–ª–æ–Ω, –¥–æ–±–∞–≤—å—Ç–µ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è.')
        else:
            recs.append('–¢—Ä–µ–Ω–¥ —Å–ª–∞–±—ã–π ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å/—Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å, –ø—Ä–∏–º–µ–Ω–∏—Ç–µ —Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑.')

        if std_val > 20:
            recs.append('–í—ã—Å–æ–∫–∏–π —Ä–∞–∑–±—Ä–æ—Å –∑–Ω–∞—á–µ–Ω–∏–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–¥–∏–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä/—Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∏ —É–≤–µ–ª–∏—á—å—Ç–µ —á–∞—Å—Ç–æ—Ç—É –∏–∑–º–µ—Ä–µ–Ω–∏–π.')
        else:
            recs.append('–†–∞–∑–±—Ä–æ—Å —É–º–µ—Ä–µ–Ω–Ω—ã–π ‚Äî —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –≤—ã–≤–æ–¥–æ–≤.')

        return jsonify({
            'success': True,
            'service': 'Electrical API',
            'analysis': {
                'image_width': int(w),
                'image_height': int(h),
                'mean_intensity': round(mean_val, 2),
                'std_intensity': round(std_val, 2),
                'edge_strength': round(edge_strength, 3),
                'trend_slope': round(slope, 5)
            },
            'recommendations': recs,
            'timestamp': datetime.now().isoformat()
        })

    except Exception as e:
        logging.exception('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è')
        return jsonify({'success': False, 'error': str(e)}), 500


# === –û—Ü–∏—Ñ—Ä–æ–≤–∫–∞ –∫—Ä–∏–≤–æ–π –≥—Ä–∞—Ñ–∏–∫–∞ (MVP) ===
@app.route('/api/graph/digitize', methods=['POST'])
def digitize_graph_image():
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç PNG/JPG, –∏–∑–≤–ª–µ–∫–∞–µ—Ç –æ–¥–Ω—É —Ç—ë–º–Ω—É—é –∫—Ä–∏–≤—É—é –Ω–∞ —Å–≤–µ—Ç–ª–æ–º —Ñ–æ–Ω–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—á–∫–∏."""
    try:
        if not PIL_NUMPY_AVAILABLE:
            return jsonify({'success': False, 'error': 'Pillow/Numpy –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã'}), 500

        if 'file' not in request.files:
            return jsonify({'success': False, 'error': '–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª (form-data key=file)'}), 400

        raw = request.files['file'].read()
        if not raw:
            return jsonify({'success': False, 'error': '–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª'}), 400

        # –ì–æ—Ç–æ–≤–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        img = Image.open(BytesIO(raw)).convert('L')  # grayscale
        arr = np.asarray(img, dtype=np.uint8)
        h, w = arr.shape

        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ—Å—Ç–∞—è –±–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—è (–ª–∏–Ω–∏—è —Ç—ë–º–Ω–∞—è)
        # –ü–æ—Ä–æ–≥ –≤—ã–±–µ—Ä–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –ø–æ 20-–º—É –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—é —è—Ä–∫–æ—Å—Ç–∏
        thr = int(np.percentile(arr, 20))
        mask = arr <= thr  # True —Ç–∞–º, –≥–¥–µ —Ç—ë–º–Ω–∞—è –ª–∏–Ω–∏—è/—Å–µ—Ç–∫–∞

        # –£–±–µ—Ä—ë–º —Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã–π —à—É–º: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–∏–∫—Å–µ–ª–∏, –≥–¥–µ –≤ 3x3 –æ–∫–Ω–µ –º–∞–ª–æ —Ç—ë–º–Ω—ã—Ö
        # (–ø—Ä–æ—Å—Ç–∞—è –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—è –±–µ–∑ scipy)
        pad = np.pad(mask.astype(np.uint8), ((1,1),(1,1)), 'constant', constant_values=0)
        dens = (
            pad[0:-2,0:-2] + pad[0:-2,1:-1] + pad[0:-2,2:] +
            pad[1:-1,0:-2] + pad[1:-1,1:-1] + pad[1:-1,2:] +
            pad[2:  ,0:-2] + pad[2:  ,1:-1] + pad[2:  ,2:]
        )
        mask = (mask & (dens >= 3))

        # –ü–æ –∫–∞–∂–¥–æ–º—É X-—Å—Ç–æ–ª–±—Ü—É –≤—ã—á–∏—Å–ª–∏–º –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ Y –¥–ª—è —Ç—ë–º–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π
        points = []  # –≤ –ø–∏–∫—Å–µ–ª—è—Ö (x,y)
        ys = np.arange(h, dtype=np.float32)
        for x in range(w):
            col = mask[:, x]
            cnt = int(col.sum())
            if cnt == 0:
                continue
            y_mean = float((ys[col]).mean())
            points.append([x, y_mean])

        if len(points) < max(20, w * 0.02):
            return jsonify({'success': False, 'error': '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–µ–ª–∏—Ç—å –∫—Ä–∏–≤—É—é (—Å–ª–∏—à–∫–æ–º –º–∞–ª–æ —Ç–æ—á–µ–∫)'}), 400

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ [0,1] (–æ—Å—å Y –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º ‚Äì –Ω–æ–ª—å –≤–Ω–∏–∑—É)
        norm_points = []
        for x, y in points:
            nx = x / (w - 1) if w > 1 else 0.0
            ny = 1.0 - (y / (h - 1) if h > 1 else 0.0)
            norm_points.append([round(nx, 6), round(ny, 6)])

        # –ü—Ä–æ—Å—Ç–µ–π—à–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∫—Ä–∏–≤–æ–π
        npx = np.array([p[0] for p in norm_points], dtype=np.float32)
        npy = np.array([p[1] for p in norm_points], dtype=np.float32)
        # –õ–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è –Ω–∞–∫–ª–æ–Ω–∞: y ~ a*x + b
        try:
            A = np.vstack([npx, np.ones_like(npx)]).T
            a, b = np.linalg.lstsq(A, npy, rcond=None)[0]
        except Exception:
            a, b = 0.0, float(npy.mean())

        # –ü–æ–∏—Å–∫ —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤ (–Ω–∞–∏–≤–Ω–æ): –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–∞–∫—Å/–º–∏–Ω –ø–æ –æ–∫–Ω—É 3
        peaks = []
        troughs = []
        for i in range(1, len(npy)-1):
            if npy[i] > npy[i-1] and npy[i] > npy[i+1]:
                peaks.append([float(npx[i]), float(npy[i])])
            if npy[i] < npy[i-1] and npy[i] < npy[i+1]:
                troughs.append([float(npx[i]), float(npy[i])])

        summary = {
            'trend_slope': round(float(a), 6),
            'mean': round(float(npy.mean()), 6),
            'std': round(float(npy.std()), 6),
            'points_extracted': len(points),
            'peaks': peaks[:20],
            'troughs': troughs[:20]
        }

        # –û–≥—Ä–∞–Ω–∏—á–∏–º –æ–±—ä—ë–º —Ç–æ—á–µ–∫ –≤ –æ—Ç–≤–µ—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ 2000)
        max_pts = 2000
        pts_out = points if len(points) <= max_pts else points[::len(points)//max_pts]
        npts_out = norm_points if len(norm_points) <= max_pts else norm_points[::len(norm_points)//max_pts]

        return jsonify({
            'success': True,
            'service': 'Electrical API',
            'image': {'width': int(w), 'height': int(h)},
            'points': pts_out,
            'normalized_points': npts_out,
            'summary': summary,
            'timestamp': datetime.now().isoformat()
        })

    except Exception as e:
        logging.exception('–û—à–∏–±–∫–∞ –æ—Ü–∏—Ñ—Ä–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞')
        return jsonify({'success': False, 'error': str(e)}), 500

def find_best_match(query):
    """–ü–æ–∏—Å–∫ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É"""
    query_lower = query.lower()
    
    # –ü—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    for key, data in ELECTRICAL_KNOWLEDGE.items():
        if key in query_lower:
            return data
    
    # –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    keywords = {
        "–æ–º": "–∑–∞–∫–æ–Ω –æ–º–∞",
        "–∫–∏—Ä—Ö–≥–æ—Ñ": "–∑–∞–∫–æ–Ω –∫–∏—Ä—Ö–≥–æ—Ñ–∞", 
        "–º–æ—â–Ω–æ—Å—Ç—å": "–º–æ—â–Ω–æ—Å—Ç—å",
        "—Ä–µ–∑–∏—Å—Ç–æ—Ä": "—Ä–µ–∑–∏—Å—Ç–æ—Ä",
        "–∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä": "–∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä",
        "modbus": "modbus",
        "–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ": "–∑–∞–∫–æ–Ω –æ–º–∞",
        "—Ç–æ–∫": "–∑–∞–∫–æ–Ω –æ–º–∞",
        "—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ": "–∑–∞–∫–æ–Ω –æ–º–∞",
        "—à–∏–º": "—à–∏–º",
        "–ø–ª–∞—Ç–∞": "—à–∏–º",
        "–º–æ–¥—É–ª—è—Ü–∏—è": "—à–∏–º",
        "–∏–º–ø—É–ª—å—Å–Ω–∞—è": "—à–∏–º",
        "—à–∏—Ä–æ—Ç–Ω–æ": "—à–∏–º",
        "—Å–∫–≤–∞–∂–Ω–æ—Å—Ç—å": "—à–∏–º",
        "–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ": "—à–∏–º",
        "—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä": "—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä",
        "–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": "—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä",
        "–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ": "—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä"
    }
    
    for keyword, topic in keywords.items():
        if keyword in query_lower:
            return ELECTRICAL_KNOWLEDGE[topic]
    
    return None

@app.route('/health', methods=['GET'])
def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞"""
    return jsonify({
        "status": "healthy",
        "service": "Electrical Engineering API",
        "version": "1.0.0",
        "timestamp": datetime.now().isoformat()
    })

@app.route('/api/electrical/status', methods=['GET'])
def get_status():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥—É–ª—è —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∏"""
    return jsonify({
        "status": "online",
        "module": "–≠–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∞",
        "port": 8087,
        "description": "–†–∞—Å—á–µ—Ç—ã —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–ø–µ–π, —Å—Ö–µ–º—ã, –∑–∞–∫–æ–Ω –û–º–∞, –ö–∏—Ä—Ö–≥–æ—Ñ–∞",
        "topics_available": list(ELECTRICAL_KNOWLEDGE.keys()),
        "timestamp": datetime.now().isoformat()
    })

@app.route('/api/electrical/explain', methods=['GET', 'POST'])
def explain_concept():
    """–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–π —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∏"""
    try:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∫ GET, —Ç–∞–∫ –∏ POST –∑–∞–ø—Ä–æ—Å–æ–≤
        if request.method == 'POST':
            data = request.get_json()
            concept = data.get('concept', '').strip() if data else ''
            level = data.get('level', 'detailed') if data else 'detailed'
        else:  # GET –∑–∞–ø—Ä–æ—Å
            concept = request.args.get('concept', '').strip()
            level = request.args.get('level', 'detailed')
        
        if not concept:
            return jsonify({
                "error": "–ù–µ —É–∫–∞–∑–∞–Ω–∞ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è"
            }), 400
        
        # –ü–æ–∏—Å–∫ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
        knowledge = find_best_match(concept)
        
        if knowledge:
            response = {
                "success": True,
                "concept": concept,
                "title": knowledge["title"],
                "description": knowledge["description"],
                "explanation": knowledge["explanation"]
            }
            
            if "formula" in knowledge:
                response["formula"] = knowledge["formula"]
            
            if "examples" in knowledge:
                response["examples"] = knowledge["examples"]
            
            return jsonify(response)
        else:
            return jsonify({
                "success": False,
                "message": f"–ö–æ–Ω—Ü–µ–ø—Ü–∏—è '{concept}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∏",
                "available_topics": list(ELECTRICAL_KNOWLEDGE.keys())
            })
    
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}")
        return jsonify({
            "error": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
            "details": str(e)
        }), 500

@app.route('/api/electrical/calculate', methods=['POST'])
def calculate():
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–æ–≤ –ø–æ —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–µ"""
    try:
        data = request.get_json()
        calculation_type = data.get('type', '')
        parameters = data.get('parameters', {})
        
        if calculation_type == 'ohm_law':
            # –†–∞—Å—á–µ—Ç –ø–æ –∑–∞–∫–æ–Ω—É –û–º–∞
            if 'voltage' in parameters and 'resistance' in parameters:
                current = parameters['voltage'] / parameters['resistance']
                power = parameters['voltage'] * current
                return jsonify({
                    "success": True,
                    "calculation": "–ó–∞–∫–æ–Ω –û–º–∞",
                    "input": parameters,
                    "result": {
                        "current": round(current, 3),
                        "power": round(power, 3)
                    }
                })
            elif 'current' in parameters and 'resistance' in parameters:
                voltage = parameters['current'] * parameters['resistance']
                power = voltage * parameters['current']
                return jsonify({
                    "success": True,
                    "calculation": "–ó–∞–∫–æ–Ω –û–º–∞",
                    "input": parameters,
                    "result": {
                        "voltage": round(voltage, 3),
                        "power": round(power, 3)
                    }
                })
            else:
                return jsonify({
                    "error": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–æ –∑–∞–∫–æ–Ω—É –û–º–∞"
                }), 400
        
        return jsonify({
            "error": f"–¢–∏–ø —Ä–∞—Å—á–µ—Ç–∞ '{calculation_type}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"
        }), 400
    
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ: {str(e)}")
        return jsonify({
            "error": "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ä–∞—Å—á–µ—Ç–∞",
            "details": str(e)
        }), 500

@app.route('/api/electrical/advanced_calculate', methods=['POST'])
def advanced_calculate():
    """–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ä–∞—Å—á–µ—Ç—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —É—Ç–∏–ª–∏—Ç"""
    try:
        data = request.get_json()
        calculation_type = data.get('type', '')
        parameters = data.get('parameters', {})
        
        if not calculation_type:
            return jsonify({'error': '–¢–∏–ø —Ä–∞—Å—á–µ—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω'}), 400
        
        result = {}
        
        if ELECTRICAL_UTILS_AVAILABLE:
            if calculation_type == 'ohm_law':
                voltage = parameters.get('voltage')
                current = parameters.get('current')
                resistance = parameters.get('resistance')
                
                if voltage and current:
                    result = electrical_utils.calculate_ohm_law(voltage=voltage, current=current)
                elif voltage and resistance:
                    result = electrical_utils.calculate_ohm_law(voltage=voltage, resistance=resistance)
                elif current and resistance:
                    result = electrical_utils.calculate_ohm_law(current=current, resistance=resistance)
                else:
                    return jsonify({'error': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞'}), 400
            
            elif calculation_type == 'power':
                voltage = parameters.get('voltage')
                current = parameters.get('current')
                resistance = parameters.get('resistance')
                
                if voltage and current:
                    result = electrical_utils.calculate_power(voltage=voltage, current=current)
                elif current and resistance:
                    result = electrical_utils.calculate_power(current=current, resistance=resistance)
                elif voltage and resistance:
                    result = electrical_utils.calculate_power(voltage=voltage, resistance=resistance)
                else:
                    return jsonify({'error': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–æ—â–Ω–æ—Å—Ç–∏'}), 400
            
            elif calculation_type == 'circuit_analysis':
                circuit_data = parameters.get('circuit_data', {})
                result = electrical_utils.analyze_circuit(circuit_data)
            
            else:
                return jsonify({'error': f'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ä–∞—Å—á–µ—Ç–∞: {calculation_type}'}), 400
        else:
            return jsonify({'error': '–≠–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É—Ç–∏–ª–∏—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã'}), 503
        
        return jsonify({
            'success': True,
            'calculation_type': calculation_type,
            'parameters': parameters,
            'result': result,
            'timestamp': datetime.now().isoformat()
        })
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞: {e}")
        return jsonify({'error': f'–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: {str(e)}'}), 500

@app.route('/api/electrical/knowledge_advanced', methods=['POST'])
def get_advanced_knowledge():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –∑–Ω–∞–Ω–∏–π –ø–æ —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–µ"""
    try:
        data = request.get_json()
        query = data.get('query', '')
        knowledge_type = data.get('type', 'general')
        
        if not query:
            return jsonify({'error': '–ó–∞–ø—Ä–æ—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'}), 400
        
        result = {}
        
        if ELECTRICAL_UTILS_AVAILABLE and electrical_handler:
            if knowledge_type == 'advanced':
                result = electrical_handler.get_advanced_knowledge(query)
            elif knowledge_type == 'formulas':
                result = electrical_handler.get_formulas(query)
            elif knowledge_type == 'components':
                result = electrical_handler.get_components_info(query)
            else:
                result = electrical_handler.get_general_knowledge(query)
        else:
            # Fallback –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
            result = find_best_match(query)
        
        return jsonify({
            'success': True,
            'query': query,
            'knowledge_type': knowledge_type,
            'result': result,
            'timestamp': datetime.now().isoformat()
        })
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –∑–Ω–∞–Ω–∏–π: {e}")
        return jsonify({'error': f'–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π: {str(e)}'}), 500

@app.route('/api/electrical/topics', methods=['GET'])

@app.route('/api/chat', methods=['POST'])
def chat():
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π endpoint –¥–ª—è —á–∞—Ç–∞"""
    try:
        data = request.get_json() or {}
        message = data.get('message', '').strip()
        
        if not message:
            return jsonify({
                "success": False,
                "error": "–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
            }), 400
        
        # –ü–æ–∏—Å–∫ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
        knowledge = find_best_match(message)
        
        if knowledge:
            response = {
                "success": True,
                "response": knowledge["explanation"],
                "concept": knowledge["title"],
                "server_type": "electrical",
                "timestamp": datetime.now().isoformat()
            }
            return jsonify(response)
        else:
            return jsonify({
                "success": False,
                "error": f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É: {message}",
                "suggestions": list(ELECTRICAL_KNOWLEDGE.keys())[:5]
            }), 404
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≤ chat endpoint: {e}")
        return jsonify({
            "success": False,
            "error": f"–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}"
        }), 500

if __name__ == '__main__':
    print("üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∏ –Ω–∞ –ø–æ—Ä—Ç—É 8087...")
    app.run(host='0.0.0.0', port=8087, debug=False)

