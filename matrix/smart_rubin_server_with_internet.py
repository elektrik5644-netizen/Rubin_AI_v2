#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Smart Rubin AI Server —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫–∞
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
"""

import json
import time
import sqlite3
from http.server import HTTPServer, BaseHTTPRequestHandler
from urllib.parse import urlparse, parse_qs
import threading
import os
import sys

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
try:
    from rubin_contextual_internet_search import RubinContextualInternetSearch
    INTERNET_SEARCH_AVAILABLE = True
except ImportError:
    print("‚ö†Ô∏è –ú–æ–¥—É–ª—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
    INTERNET_SEARCH_AVAILABLE = False

class SmartRubinAIWithInternetHandler(BaseHTTPRequestHandler):
    def __init__(self, *args, **kwargs):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫–∞
        if INTERNET_SEARCH_AVAILABLE:
            self.internet_searcher = RubinContextualInternetSearch()
        else:
            self.internet_searcher = None
        
        super().__init__(*args, **kwargs)
    
    def init_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            conn = sqlite3.connect('rubin_ai.db')
            cursor = conn.cursor()
            
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS messages (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    message TEXT NOT NULL,
                    response TEXT NOT NULL,
                    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
                    internet_search_used BOOLEAN DEFAULT FALSE,
                    search_category TEXT,
                    knowledge_saved BOOLEAN DEFAULT FALSE
                )
            ''')
            
            conn.commit()
            conn.close()
            return True
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î: {e}")
            return False
    
    def save_message_to_db(self, message, response, internet_search_used=False, search_category=None, knowledge_saved=False):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
        try:
            conn = sqlite3.connect('rubin_ai.db')
            cursor = conn.cursor()
            
            cursor.execute('''
                INSERT INTO messages (message, response, internet_search_used, search_category, knowledge_saved) 
                VALUES (?, ?, ?, ?, ?)
            ''', (message, response, internet_search_used, search_category, knowledge_saved))
            
            conn.commit()
            conn.close()
            return True
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î: {e}")
            return False
    
    def search_knowledge_base(self, message):
        """–ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π"""
        try:
            conn = sqlite3.connect('rubin_knowledge_base.db')
            cursor = conn.cursor()
            
            # –ò—â–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
            words = message.lower().split()
            search_terms = [word for word in words if len(word) > 3]
            
            if not search_terms:
                return None
            
            # –°–æ–∑–¥–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            search_conditions = []
            for term in search_terms:
                search_conditions.append(f"title LIKE '%{term}%' OR content LIKE '%{term}%' OR keywords LIKE '%{term}%'")
            
            search_query = " OR ".join(search_conditions)
            
            cursor.execute(f'''
                SELECT title, content, category, tags 
                FROM knowledge_base 
                WHERE {search_query}
                ORDER BY relevance_score DESC, usage_count DESC
                LIMIT 3
            ''')
            
            results = cursor.fetchall()
            conn.close()
            
            if results:
                return results[0]  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            
            return None
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ –ë–ó: {e}")
            return None
    
    def generate_smart_response(self, message):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫–æ–º"""
        message_lower = message.lower()
        
        # –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        if any(word in message_lower for word in ["–∫–æ–Ω—Ç–∞–∫—Ç–æ—Ä", "—Ä–µle"]) and any(word in message_lower for word in ["–æ–¥–Ω–æ", "—Ç–æ –∂–µ", "—ç—Ç–æ", "—Ä–∞–≤–Ω–æ"]):
            return """‚ö° **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç—å –≤ –≤–æ–ø—Ä–æ—Å–µ!**

‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:** –ö–æ–Ω—Ç–∞–∫—Ç–æ—Ä—ã –∏ —Ä–µ–ª–µ - —ç—Ç–æ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:** –ö–æ–Ω—Ç–∞–∫—Ç–æ—Ä—ã –∏ —Ä–µ–ª–µ - —ç—Ç–æ **—Ä–∞–∑–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** —Å —Ä–∞–∑–Ω—ã–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è:**

**–†–µ–ª–µ:**
‚Ä¢ **–ú–æ—â–Ω–æ—Å—Ç—å** - –¥–æ 10 –ê, –Ω–∏–∑–∫–æ–≤–æ–ª—å—Ç–Ω—ã–µ —Ü–µ–ø–∏
‚Ä¢ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è, –ª–æ–≥–∏–∫–∞
‚Ä¢ **–ö–æ–Ω—Ç–∞–∫—Ç—ã** - –º–∞–ª–æ–º–æ—â–Ω—ã–µ, –¥–ª—è —Å–ª–∞–±–æ—Ç–æ—á–Ω—ã—Ö —Ü–µ–ø–µ–π
‚Ä¢ **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ** - —Å—Ö–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞
‚Ä¢ **–†–∞–∑–º–µ—Ä** - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ, –º–æ–¥—É–ª—å–Ω—ã–µ

**–ö–æ–Ω—Ç–∞–∫—Ç–æ—Ä—ã:**
‚Ä¢ **–ú–æ—â–Ω–æ—Å—Ç—å** - –æ—Ç 10 –ê –¥–æ —Å–æ—Ç–µ–Ω –∞–º–ø–µ—Ä
‚Ä¢ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ** - –∫–æ–º–º—É—Ç–∞—Ü–∏—è —Å–∏–ª–æ–≤—ã—Ö —Ü–µ–ø–µ–π
‚Ä¢ **–ö–æ–Ω—Ç–∞–∫—Ç—ã** - –º–æ—â–Ω—ã–µ, –¥–ª—è —Å–∏–ª–æ–≤—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
‚Ä¢ **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–≥–∞—Ç–µ–ª—è–º–∏, –Ω–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—è–º–∏
‚Ä¢ **–†–∞–∑–º–µ—Ä** - –∫—Ä—É–ø–Ω—ã–µ, —Å –¥—É–≥–æ–≥–∞—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∫–∞–º–µ—Ä–∞–º–∏

**–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

**–†–µ–ª–µ:**
‚Ä¢ **–ö–∞—Ç—É—à–∫–∞** - 5-24 –í DC/AC
‚Ä¢ **–ö–æ–Ω—Ç–∞–∫—Ç—ã** - NO, NC, –ø–µ—Ä–µ–∫–ª—é—á–∞—é—â–∏–µ
‚Ä¢ **–î—É–≥–∞** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≥–∞—à–µ–Ω–∏—è
‚Ä¢ **–°—Ä–æ–∫ —Å–ª—É–∂–±—ã** - –º–∏–ª–ª–∏–æ–Ω—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π

**–ö–æ–Ω—Ç–∞–∫—Ç–æ—Ä—ã:**
‚Ä¢ **–ö–∞—Ç—É—à–∫–∞** - 24-380 –í AC/DC
‚Ä¢ **–ö–æ–Ω—Ç–∞–∫—Ç—ã** - —Å–∏–ª–æ–≤—ã–µ, —Å –¥—É–≥–æ–≥–∞—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∫–∞–º–µ—Ä–∞–º–∏
‚Ä¢ **–î—É–≥–∞** - —Ç—Ä–µ–±—É–µ—Ç –≥–∞—à–µ–Ω–∏—è (–º–∞–≥–Ω–∏—Ç–Ω–æ–µ, –≤–æ–∑–¥—É—à–Ω–æ–µ)
‚Ä¢ **–°—Ä–æ–∫ —Å–ª—É–∂–±—ã** - —Å–æ—Ç–Ω–∏ —Ç—ã—Å—è—á –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π

**–í –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏:**
‚Ä¢ **PLC** - —Ä–µ–ª–µ –¥–ª—è –ª–æ–≥–∏–∫–∏, –∫–æ–Ω—Ç–∞–∫—Ç–æ—Ä—ã –¥–ª—è —Å–∏–ª–æ–≤—ã—Ö —Ü–µ–ø–µ–π
‚Ä¢ **–°—Ö–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** - —Ä–µ–ª–µ –¥–ª—è —Å–∏–≥–Ω–∞–ª–æ–≤, –∫–æ–Ω—Ç–∞–∫—Ç–æ—Ä—ã –¥–ª—è –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π
‚Ä¢ **–ó–∞—â–∏—Ç–∞** - —Ä–µ–ª–µ –∫–æ–Ω—Ç—Ä–æ–ª—è, –∫–æ–Ω—Ç–∞–∫—Ç–æ—Ä—ã —Å —Ç–µ–ø–ª–æ–≤—ã–º–∏ —Ä–µ–ª–µ

**–í—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
‚Ä¢ **–†–µ–ª–µ** - –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏, —Å–ª–∞–±–æ—Ç–æ—á–Ω—ã—Ö —Ü–µ–ø–µ–π
‚Ä¢ **–ö–æ–Ω—Ç–∞–∫—Ç–æ—Ä—ã** - –¥–ª—è –∫–æ–º–º—É—Ç–∞—Ü–∏–∏ –º–æ—â–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫, –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π

–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –≤—ã–±–æ—Ä–æ–º –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?"""

        # –ß–∞—Å—Ç–æ—Ç–Ω—ã–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª–∏
        if any(word in message_lower for word in ["—á–∞—Å—Ç–æ—Ç–Ω", "–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª", "–∏–Ω–≤–µ—Ä—Ç–æ—Ä", "vfd", "—á–∞—Å—Ç–æ—Ç–Ω–∏–∫"]):
            return """‚ö° **–ß–∞—Å—Ç–æ—Ç–Ω—ã–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª–∏ - –æ—Å–Ω–æ–≤–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏!**

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
‚Ä¢ **–í—ã–ø—Ä—è–º–ª–µ–Ω–∏–µ** - AC ‚Üí DC (–¥–∏–æ–¥–Ω—ã–π –º–æ—Å—Ç)
‚Ä¢ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø—É–ª—å—Å–∞—Ü–∏–π (–∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä—ã)
‚Ä¢ **–ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - DC ‚Üí AC (IGBT —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä—ã)
‚Ä¢ **–®–ò–ú –º–æ–¥—É–ª—è—Ü–∏—è** - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—É—Å–æ–∏–¥—ã

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
‚Ä¢ **–ü–ª–∞–≤–Ω—ã–π –ø—É—Å–∫** - —Å–Ω–∏–∂–µ–Ω–∏–µ –ø—É—Å–∫–æ–≤—ã—Ö —Ç–æ–∫–æ–≤
‚Ä¢ **–†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏** - 0-100% –æ—Ç –Ω–æ–º–∏–Ω–∞–ª—å–Ω–æ–π
‚Ä¢ **–†–µ–≤–µ—Ä—Å** - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Ä–∞—â–µ–Ω–∏—è
‚Ä¢ **–¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ** - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏ —Ä–µ–∫—É–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ

**–¢–∏–ø—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
‚Ä¢ **–°–∫–∞–ª—è—Ä–Ω–æ–µ (U/f)** - –ø—Ä–æ—Å—Ç–æ–µ, –¥–ª—è –Ω–∞—Å–æ—Å–æ–≤/–≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–≤
‚Ä¢ **–í–µ–∫—Ç–æ—Ä–Ω–æ–µ** - —Ç–æ—á–Ω–æ–µ, –¥–ª—è —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–æ–≤
‚Ä¢ **–ü—Ä—è–º–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–º–µ–Ω—Ç–æ–º** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
‚Ä¢ **–ù–æ–º–∏–Ω–∞–ª—å–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–≤–∏–≥–∞—Ç–µ–ª—é
‚Ä¢ **–ß–∞—Å—Ç–æ—Ç–∞** - 0-400 –ì—Ü (–æ–±—ã—á–Ω–æ 0-50 –ì—Ü)
‚Ä¢ **–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ** - 220–í/380–í/660–í
‚Ä¢ **–¢–æ–∫** - –Ω–æ–º–∏–Ω–∞–ª—å–Ω—ã–π –∏ –ø—É—Å–∫–æ–≤–æ–π

**–ó–∞—â–∏—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
‚Ä¢ **–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è —Ç–æ–∫–∞
‚Ä¢ **–ü–µ—Ä–µ–≥—Ä–µ–≤** - —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∞—è –∑–∞—â–∏—Ç–∞
‚Ä¢ **–ö–æ—Ä–æ—Ç–∫–æ–µ –∑–∞–º—ã–∫–∞–Ω–∏–µ** - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ
‚Ä¢ **–û–±—Ä—ã–≤ —Ñ–∞–∑—ã** - –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–∏—Ç–∞—é—â–µ–π —Å–µ—Ç–∏

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
‚Ä¢ **–ù–∞—Å–æ—Å—ã** - —ç–∫–æ–Ω–æ–º–∏—è —ç–Ω–µ—Ä–≥–∏–∏ –¥–æ 50%
‚Ä¢ **–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä—ã** - –ø–ª–∞–≤–Ω–∞—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞
‚Ä¢ **–ö–æ–Ω–≤–µ–π–µ—Ä—ã** - —Ç–æ—á–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ **–°—Ç–∞–Ω–∫–∏** - —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ —à–ø–∏–Ω–¥–µ–ª—è

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:**
‚Ä¢ **–í—Ö–æ–¥** - 3-—Ñ–∞–∑–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ 380–í
‚Ä¢ **–í—ã—Ö–æ–¥** - –∫ –¥–≤–∏–≥–∞—Ç–µ–ª—é (U, V, W)
‚Ä¢ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –∞–Ω–∞–ª–æ–≥–æ–≤—ã–µ/—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã
‚Ä¢ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å** - —ç–Ω–∫–æ–¥–µ—Ä—ã, —Ç–∞—Ö–æ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ HMI:**
‚Ä¢ **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è** - –º–æ—â–Ω–æ—Å—Ç—å, —Ç–æ–∫, —á–∞—Å—Ç–æ—Ç–∞
‚Ä¢ **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏** - –º–æ–º–µ–Ω—Ç, –∏–Ω–µ—Ä—Ü–∏—è
‚Ä¢ **–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã** - —Ä—É—á–Ω–æ–π/–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π
‚Ä¢ **–ó–∞—â–∏—Ç—ã** - —É—Å—Ç–∞–≤–∫–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è

–ö–∞–∫–æ–π –∞—Å–ø–µ–∫—Ç —á–∞—Å—Ç–æ—Ç–Ω—ã—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"""

        # –≠–Ω–∫–æ–¥–µ—Ä—ã
        if "—ç–Ω–∫–æ–¥–µ—Ä" in message_lower:
            return """üîç **–≠–Ω–∫–æ–¥–µ—Ä—ã - –≥–ª–∞–∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏!**

**–¢–∏–ø—ã —ç–Ω–∫–æ–¥–µ—Ä–æ–≤:**

**–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ:**
‚Ä¢ **–ü—Ä–∏–Ω—Ü–∏–ø** - –∏–º–ø—É–ª—å—Å—ã A, B, Z
‚Ä¢ **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ** - 100-10000 –∏–º–ø/–æ–±
‚Ä¢ **–í—ã—Ö–æ–¥** - TTL, HTL, RS422
‚Ä¢ **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ** - —Å–∫–æ—Ä–æ—Å—Ç—å, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–ê–±—Å–æ–ª—é—Ç–Ω—ã–µ:**
‚Ä¢ **–ü—Ä–∏–Ω—Ü–∏–ø** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø–æ–∑–∏—Ü–∏–∏
‚Ä¢ **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ** - 12-24 –±–∏—Ç–∞ (4096-16M –ø–æ–∑–∏—Ü–∏–π)
‚Ä¢ **–í—ã—Ö–æ–¥** - SSI, Profibus, Ethernet
‚Ä¢ **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ** - —Ç–æ—á–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**–û–ø—Ç–∏—á–µ—Å–∫–∏–µ:**
‚Ä¢ **–ü—Ä–∏–Ω—Ü–∏–ø** - —Å–≤–µ—Ç–æ–¥–∏–æ–¥ + —Ñ–æ—Ç–æ–¥–∏–æ–¥
‚Ä¢ **–¢–æ—á–Ω–æ—Å—Ç—å** - –≤—ã—Å–æ–∫–∞—è, –¥–æ 0.01¬∞
‚Ä¢ **–°–∫–æ—Ä–æ—Å—Ç—å** - –¥–æ 10000 –æ–±/–º–∏–Ω
‚Ä¢ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∏—Å—Ç–æ—Ç—ã

**–ú–∞–≥–Ω–∏—Ç–Ω—ã–µ:**
‚Ä¢ **–ü—Ä–∏–Ω—Ü–∏–ø** - –º–∞–≥–Ω–∏—Ç–Ω–æ–µ –ø–æ–ª–µ + –¥–∞—Ç—á–∏–∫ –•–æ–ª–ª–∞
‚Ä¢ **–¢–æ—á–Ω–æ—Å—Ç—å** - —Å—Ä–µ–¥–Ω—è—è, –¥–æ 0.1¬∞
‚Ä¢ **–°–∫–æ—Ä–æ—Å—Ç—å** - –¥–æ 6000 –æ–±/–º–∏–Ω
‚Ä¢ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –≤—ã—Å–æ–∫–∞—è, –Ω–µ –±–æ–∏—Ç—Å—è –≥—Ä—è–∑–∏

**–ò–Ω–¥—É–∫—Ç–∏–≤–Ω—ã–µ:**
‚Ä¢ **–ü—Ä–∏–Ω—Ü–∏–ø** - —ç–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –∏–Ω–¥—É–∫—Ü–∏—è
‚Ä¢ **–¢–æ—á–Ω–æ—Å—Ç—å** - –≤—ã—Å–æ–∫–∞—è, –¥–æ 0.001¬∞
‚Ä¢ **–°–∫–æ—Ä–æ—Å—Ç—å** - –¥–æ 30000 –æ–±/–º–∏–Ω
‚Ä¢ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PLC:**
‚Ä¢ **–¶–∏—Ñ—Ä–æ–≤—ã–µ –≤—Ö–æ–¥—ã** - –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö
‚Ä¢ **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏** - –¥–ª—è –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö
‚Ä¢ **–°—á–µ—Ç—á–∏–∫–∏** - –ø–æ–¥—Å—á–µ—Ç –∏–º–ø—É–ª—å—Å–æ–≤
‚Ä¢ **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã** - SSI, Profibus, Ethernet

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ PMAC:**
‚Ä¢ **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–º–ø—É–ª—å—Å–æ–≤ –Ω–∞ –æ–±–æ—Ä–æ—Ç
‚Ä¢ **–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –ø—Ä—è–º–∞—è/–æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
‚Ä¢ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –ø–æ–º–µ—Ö
‚Ä¢ **–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞** - —Ç–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º:**
‚Ä¢ **–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–∞** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∏—Ç–∞–Ω–∏—è, –∫–∞–±–µ–ª–µ–π
‚Ä¢ **–ù–µ—Ç–æ—á–Ω–æ—Å—Ç—å** - –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞, –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ
‚Ä¢ **–ü–æ–º–µ—Ö–∏** - —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞–∑–µ–º–ª–µ–Ω–∏–µ
‚Ä¢ **–ò–∑–Ω–æ—Å** - –∑–∞–º–µ–Ω–∞ –ø–æ–¥—à–∏–ø–Ω–∏–∫–æ–≤, –¥–∏—Å–∫–∞

**–í—ã–±–æ—Ä —ç–Ω–∫–æ–¥–µ—Ä–∞:**
‚Ä¢ **–¢–æ—á–Ω–æ—Å—Ç—å** - —Ç—Ä–µ–±—É–µ–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
‚Ä¢ **–°–∫–æ—Ä–æ—Å—Ç—å** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã
‚Ä¢ **–°—Ä–µ–¥–∞** - —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤–ª–∞–∂–Ω–æ—Å—Ç—å, –≤–∏–±—Ä–∞—Ü–∏—è
‚Ä¢ **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å** - —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º

–ö–∞–∫–æ–π —Ç–∏–ø —ç–Ω–∫–æ–¥–µ—Ä–∞ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"""

        # –ü–æ–∏—Å–∫ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        knowledge_result = self.search_knowledge_base(message)
        if knowledge_result:
            title, content, category, tags = knowledge_result
            return f"""üß† **–ù–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π:**

**üìö {title}**
*–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}*

{content}

*–¢–µ–≥–∏: {tags}*

–ù—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ?"""

        # –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫ –¥–ª—è –Ω–æ–≤—ã—Ö/–∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        if self.internet_searcher:
            print("üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫–∞...")
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
            search_result = self.internet_searcher.process_user_message(message)
            
            if search_result['needs_internet_search']:
                print(f"üîç –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ: {search_result['search_category']}")
                
                if search_result['internet_results']:
                    response = f"""üåê **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞:**

üîç **–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É:** "{message}"
üìÇ **–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞:** {search_result['search_category']}

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:**

"""
                    
                    for i, result in enumerate(search_result['internet_results'], 1):
                        response += f"{i}. **{result['title']}**\n"
                        response += f"   üîó {result['url']}\n"
                        response += f"   üìù {result['snippet']}\n\n"
                    
                    # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                    if search_result['analyzed_content']:
                        analyzed = search_result['analyzed_content']
                        response += f"""üìÑ **–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**

**{analyzed['title']}**

{analyzed['content'][:1000]}{'...' if len(analyzed['content']) > 1000 else ''}

üîó **–ò—Å—Ç–æ—á–Ω–∏–∫:** {analyzed['url']}

"""
                        
                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞–Ω–∏—è –≤ –±–∞–∑—É
                        if self.internet_searcher.save_knowledge_from_internet(analyzed, message):
                            response += "üíæ **–ó–Ω–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑—É –¥–ª—è –±—É–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤!**\n\n"
                    
                    response += """‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π.
üîó –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–∞–º –≤—ã—à–µ."""
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–ª–∞–≥–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫–∞
                    self.save_message_to_db(
                        message, response, 
                        internet_search_used=True,
                        search_category=search_result['search_category'],
                        knowledge_saved=bool(search_result['analyzed_content'])
                    )
                    
                    return response
                else:
                    return f"""ü§î **–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å:** "{message}"

üåê **–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –Ω–µ –¥–∞–ª–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.**

üéØ **–ú–æ—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
‚Ä¢ –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
‚Ä¢ –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ PLC –∏ PMAC
‚Ä¢ –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç—á–∏–∫–∞–º–∏ –∏ –ø—Ä–∏–≤–æ–¥–∞–º–∏
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞

üí° **–î–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ —É—Ç–æ—á–Ω–∏—Ç–µ:**
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É
‚Ä¢ –¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏–ª–∏ —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
‚Ä¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

üîß **–ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:**
‚Ä¢ "–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ—Ä–º–æ–ø–∞—Ä—É —Ç–∏–ø–∞ K –≤ —Å–∏—Å—Ç–µ–º–µ Siemens?"
‚Ä¢ "–ü—Ä–æ–≥—Ä–∞–º–º–∞ PLC –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–æ–º"
‚Ä¢ "–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ Python –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–æ–≤"
‚Ä¢ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ PMAC –¥–ª—è 3-–æ—Å–µ–≤–æ–≥–æ —Å—Ç–∞–Ω–∫–∞"

**–ó–∞–¥–∞–π—Ç–µ –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∏ —è –¥–∞–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç!**"""

        # Fallback –æ—Ç–≤–µ—Ç
        return f"""ü§ñ **–ü–æ–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å:** "{message}"

üéØ **–ú–æ—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
‚Ä¢ –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
‚Ä¢ –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ PLC –∏ PMAC
‚Ä¢ –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç—á–∏–∫–∞–º–∏ –∏ –ø—Ä–∏–≤–æ–¥–∞–º–∏
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞

üí° **–î–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ —É—Ç–æ—á–Ω–∏—Ç–µ:**
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É
‚Ä¢ –¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏–ª–∏ —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ –ï—Å—Ç—å –ª–∏ –∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞?
‚Ä¢ –ö–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞–∂–Ω—ã?

üîß **–ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:**
‚Ä¢ "–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ—Ä–º–æ–ø–∞—Ä—É —Ç–∏–ø–∞ K –≤ —Å–∏—Å—Ç–µ–º–µ Siemens?"
‚Ä¢ "–ü—Ä–æ–≥—Ä–∞–º–º–∞ PLC –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–æ–º"
‚Ä¢ "–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ Python –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞–º–∏"
‚Ä¢ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ PMAC –¥–ª—è 3-–æ—Å–µ–≤–æ–≥–æ —Å—Ç–∞–Ω–∫–∞"

**–ó–∞–¥–∞–π—Ç–µ –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∏ —è –¥–∞–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç!**"""
    
    def do_POST(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ POST –∑–∞–ø—Ä–æ—Å–æ–≤"""
        if self.path == '/api/chat':
            try:
                content_length = int(self.headers['Content-Length'])
                post_data = self.rfile.read(content_length)
                data = json.loads(post_data.decode('utf-8'))
                
                message = data.get('message', '')
                if not message:
                    self.send_error_response('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º')
                    return
                
                print(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message}")
                
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
                response = self.generate_smart_response(message)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                self.send_json_response({
                    'response': response,
                    'timestamp': time.strftime('%Y-%m-%d %H:%M:%S')
                })
                
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ POST: {e}")
                self.send_error_response(f'–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}')
        else:
            self.send_error_response('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π endpoint')
    
    def do_GET(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ GET –∑–∞–ø—Ä–æ—Å–æ–≤"""
        if self.path == '/health':
            self.send_json_response({
                'status': 'ok',
                'timestamp': time.strftime('%Y-%m-%d %H:%M:%S'),
                'internet_search_available': INTERNET_SEARCH_AVAILABLE,
                'pid': os.getpid()
            })
        elif self.path == '/api/stats':
            self.send_stats_response()
        else:
            self.send_error_response('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π endpoint')
    
    def send_stats_response(self):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        try:
            conn = sqlite3.connect('rubin_ai.db')
            cursor = conn.cursor()
            
            # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            cursor.execute('SELECT COUNT(*) FROM messages')
            total_messages = cursor.fetchone()[0]
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫—É
            cursor.execute('SELECT COUNT(*) FROM messages WHERE internet_search_used = 1')
            internet_searches = cursor.fetchone()[0]
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é –∑–Ω–∞–Ω–∏–π
            cursor.execute('SELECT COUNT(*) FROM messages WHERE knowledge_saved = 1')
            knowledge_saved = cursor.fetchone()[0]
            
            # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞
            cursor.execute('SELECT search_category, COUNT(*) FROM messages WHERE search_category IS NOT NULL GROUP BY search_category')
            search_categories = dict(cursor.fetchall())
            
            conn.close()
            
            self.send_json_response({
                'total_messages': total_messages,
                'internet_searches': internet_searches,
                'knowledge_saved': knowledge_saved,
                'search_categories': search_categories,
                'internet_search_available': INTERNET_SEARCH_AVAILABLE
            })
            
        except Exception as e:
            self.send_error_response(f'–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {str(e)}')
    
    def send_json_response(self, data):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON –æ—Ç–≤–µ—Ç"""
        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
        
        response = json.dumps(data, ensure_ascii=False, indent=2)
        self.wfile.write(response.encode('utf-8'))
    
    def send_error_response(self, error_message):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç —Å –æ—à–∏–±–∫–æ–π"""
        self.send_response(400)
        self.send_header('Content-type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        
        error_response = json.dumps({'error': error_message}, ensure_ascii=False)
        self.wfile.write(error_response.encode('utf-8'))
    
    def log_message(self, format, *args):
        """–û—Ç–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å"""
        pass

def run_server(port=8083):
    """–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞"""
    print("üöÄ –ó–∞–ø—É—Å–∫ Smart Rubin AI Server —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫–æ–º...")
    print(f"üì° –ü–æ—Ä—Ç: {port}")
    print(f"üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫: {'‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' if INTERNET_SEARCH_AVAILABLE else '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}")
    print("=" * 60)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    handler = SmartRubinAIWithInternetHandler
    temp_handler = handler(None, None, None)
    if temp_handler.init_database():
        print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    else:
        print("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
        return
    
    try:
        server = HTTPServer(('localhost', port), handler)
        print(f"üéâ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:{port}")
        print("üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints:")
        print(f"   POST http://localhost:{port}/api/chat - —á–∞—Ç —Å AI")
        print(f"   GET  http://localhost:{port}/health - —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞")
        print(f"   GET  http://localhost:{port}/api/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
        print("\nüõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
        print("=" * 60)
        
        server.serve_forever()
        
    except KeyboardInterrupt:
        print("\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...")
        server.shutdown()
        print("‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {e}")

if __name__ == "__main__":
    run_server()
