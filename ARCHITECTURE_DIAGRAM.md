# Диаграмма новой архитектуры системы

## Новая цепочка обработки запросов

```
┌─────────────┐
│   Запрос    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────┐
│     IntelligentDispatcher       │
│  (Анализ категории запроса)     │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│    SequentialSearchEngine       │
│                                 │
│  ┌─────────────────────────────┐│
│  │     Этап 1: Векторный поиск ││
│  │  (20 файлов-кандидатов)     ││
│  └─────────────┬───────────────┘│
│                │                │
│                ▼                │
│  ┌─────────────────────────────┐│
│  │   Этап 2: Текстовый поиск   ││
│  │  (контент в файлах)         ││
│  └─────────────┬───────────────┘│
│                │                │
│                ▼                │
│  ┌─────────────────────────────┐│
│  │  Этап 3: Ранжирование       ││
│  │  (3 лучших результата)      ││
│  └─────────────┬───────────────┘│
└────────────────┼─────────────────┘
                 │
                 ▼
┌─────────────────────────────────┐
│       DataProcessor             │
│                                 │
│  • Фильтрация контента          │
│  • Удаление дубликатов          │
│  • Оценка качества              │
│  • Валидация                    │
└─────────────┬───────────────────┘
              │
              ▼
┌─────────────────────────────────┐
│      LocalLLMProvider           │
│                                 │
│  • Генерация ответа             │
│  • Обработка контекста          │
│  • Валидация ответа             │
└─────────────┬───────────────────┘
              │
              ▼
┌─────────────┐
│   Ответ     │
└─────────────┘
```

## Сравнение архитектур

### Старая архитектура:
```
Запрос → Гибридный поиск → LLM → Ответ
```

### Новая архитектура:
```
Запрос → Векторный поиск → Текстовый поиск → DataProcessor → LLM → Ответ
```

## Компоненты системы

### 1. SequentialSearchEngine
- **Вход**: Текстовый запрос
- **Выход**: 3 релевантных результата с контентом
- **Процесс**: 3-этапный поиск

### 2. DataProcessor
- **Вход**: Результаты поиска
- **Выход**: Очищенный и структурированный контент
- **Процесс**: Фильтрация, дедупликация, оценка качества

### 3. IntelligentDispatcher
- **Вход**: Запрос пользователя
- **Выход**: Структурированный ответ
- **Процесс**: Маршрутизация и координация

### 4. LocalLLMProvider
- **Вход**: Обработанный контент + запрос
- **Выход**: Сгенерированный ответ
- **Процесс**: Генерация текста на основе контекста

## Потоки данных

### Основной поток:
1. **Запрос** → IntelligentDispatcher
2. **Анализ категории** → SequentialSearchEngine
3. **Векторный поиск** → 20 файлов-кандидатов
4. **Текстовый поиск** → Релевантный контент
5. **Ранжирование** → 3 лучших результата
6. **Обработка данных** → Очищенный контент
7. **Генерация ответа** → LLM
8. **Валидация** → Финальный ответ

### Альтернативные потоки:
- **Простые запросы** → Прямой ответ (привет, помощь)
- **Fallback** → Локальный LLM без контекста
- **Ошибки** → Базовый ответ с извинениями

## Метрики качества

### SequentialSearchEngine:
- Время поиска: ~0.2-0.5с
- Количество кандидатов: 20 файлов
- Финальных результатов: 3

### DataProcessor:
- Порог качества: ≥ 0.3
- Оценка релевантности: 0.0-1.0
- Фильтрация дубликатов: Да

### LocalLLMProvider:
- Валидация ответа: Да
- Проверка читаемости: Да
- Минимальная длина: 50 символов






















