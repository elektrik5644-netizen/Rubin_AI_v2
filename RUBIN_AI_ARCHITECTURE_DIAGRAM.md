# 🏗️ Архитектура Rubin AI v2.0 - Диаграмма потока данных

## 📊 Общая схема системы

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПОЛЬЗОВАТЕЛЬ                                │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              🌐 ВЕБ-ИНТЕРФЕЙС (Frontend)                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   RubinIDE.html │  │ RubinDeveloper  │  │   Статические   │ │
│  │     (8085)      │  │     (8085)      │  │     файлы       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │ HTTP POST /api/chat
                      │ Content-Type: application/json
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              🧠 AI ЧАТ СЕРВЕР (8084)                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  📡 API Gateway - Маршрутизация запросов                   │ │
│  │  🔍 Анализ сообщения → Категоризация                       │ │
│  │  📋 Определение типа запроса                               │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              📋 МАРШРУТИЗАЦИЯ К МОДУЛЯМ                        │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │Контроллеры  │  │Электротех-  │  │Радиомеха-   │  │Общие    │ │
│  │   (8090)    │  │ника (8087)  │  │ника (8089)  │  │ответы   │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              🗄️ БАЗА ДАННЫХ (SQLite)                           │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Документы     │  │ Текстовый индекс│  │ Векторный поиск │ │
│  │   (documents)   │  │(document_index) │  │(document_vectors│ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              🔍 ПОИСКОВЫЕ ДВИЖКИ                                │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ Текстовый поиск │  │ Векторный поиск │  │ Гибридный поиск │ │
│  │   (LIKE, SQL)   │  │ (Embeddings)    │  │ (Text + Vector) │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              🤖 ГЕНЕРАЦИЯ ОТВЕТА                                │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ Специализирован-│  │ Поиск в БД      │  │ Форматирование  │ │
│  │ ные ответы      │  │ + ранжирование  │  │ JSON ответа     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              📤 HTTP RESPONSE                                   │
│                                                                 │
│  Content-Type: application/json                                 │
│  {                                                              │
│    "response": "Ответ системы...",                              │
│    "category": "controllers",                                   │
│    "provider": "PLC Specialist",                                │
│    "search_results": [...],                                     │
│    "metadata": {...}                                            │
│  }                                                              │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              🌐 ОТОБРАЖЕНИЕ РЕЗУЛЬТАТА                          │
│                    (Frontend)                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 Детальный поток HTTP запросов

### **1. Инициация запроса**
```
ПОЛЬЗОВАТЕЛЬ
    │
    ▼ Ввод сообщения
┌─────────────────┐
│   RubinIDE.html │
│  (JavaScript)   │
└─────────────────┘
    │
    ▼ JSON.stringify()
┌─────────────────┐
│   HTTP POST     │
│ /api/chat       │
│ Content-Type:   │
│ application/json│
└─────────────────┘
```

### **2. Обработка на сервере**
```
┌─────────────────┐
│ AI Chat Server  │
│    (8084)       │
└─────────────────┘
    │
    ▼ request.get_json()
┌─────────────────┐
│   Анализ        │
│   сообщения     │
└─────────────────┘
    │
    ▼ categorize()
┌─────────────────┐
│  Категоризация  │
│  (controllers,  │
│  electrical,    │
│  radiomechanics)│
└─────────────────┘
```

### **3. Маршрутизация**
```
┌─────────────────┐
│   Маршрутизация │
│   к модулям     │
└─────────────────┘
    │
    ▼
┌─────┬─────┬─────┬─────┐
│PLC  │Elec │Radio│Gen  │
│8090 │8087 │8089 │eral │
└─────┴─────┴─────┴─────┘
```

### **4. Поиск в базе данных**
```
┌─────────────────┐
│   База данных   │
│   (SQLite)      │
└─────────────────┘
    │
    ▼
┌─────┬─────┬─────┐
│Docs │Text │Vec  │
│     │Idx  │Idx  │
└─────┴─────┴─────┘
    │
    ▼
┌─────────────────┐
│   Результаты    │
│   поиска        │
└─────────────────┘
```

## 📦 Структура JSON пакетов

### **HTTP Request (Frontend → Backend):**
```json
{
    "message": "Как работает ПИД-регулятор?",
    "timestamp": "2025-09-14T22:30:00.000Z",
    "session_id": "sess_12345",
    "user_preferences": {
        "language": "ru",
        "detail_level": "detailed"
    }
}
```

### **HTTP Response (Backend → Frontend):**
```json
{
    "response": "ПИД-регулятор (Пропорционально-Интегрально-Дифференциальный)...",
    "category": "controllers",
    "provider": "PLC Specialist",
    "timestamp": "2025-09-14T22:30:01.500Z",
    "search_results": [
        {
            "document_id": 1,
            "file_name": "PID_controller_manual.pdf",
            "similarity": 0.95,
            "content_preview": "ПИД-регулятор используется для..."
        }
    ],
    "metadata": {
        "processing_time": 1.2,
        "search_type": "hybrid",
        "confidence": 0.92,
        "vector_search_used": true,
        "text_search_used": true
    },
    "status": "success"
}
```

## 🗄️ Схема базы данных

```
┌─────────────────────────────────────────────────────────────────┐
│                    БАЗА ДАННЫХ SQLite                          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    documents                                │ │
│  │  ┌─────────┬─────────────┬─────────────┬─────────────────┐ │ │
│  │  │   id    │ file_name   │  content    │   category      │ │ │
│  │  ├─────────┼─────────────┼─────────────┼─────────────────┤ │ │
│  │  │    1    │ manual.pdf  │ Содержимое  │ controllers     │ │ │
│  │  │    2    │ guide.docx  │ Содержимое  │ electrical      │ │ │
│  │  └─────────┴─────────────┴─────────────┴─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 document_index                              │ │
│  │  ┌─────────┬─────────────┬─────────────┬─────────────────┐ │ │
│  │  │   id    │document_id  │  keyword    │   position      │ │ │
│  │  ├─────────┼─────────────┼─────────────┼─────────────────┤ │ │
│  │  │    1    │      1      │    пид      │       5         │ │ │
│  │  │    2    │      1      │ регулятор   │       6         │ │ │
│  │  └─────────┴─────────────┴─────────────┴─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                document_vectors                             │ │
│  │  ┌─────────┬─────────────┬─────────────┬─────────────────┐ │ │
│  │  │   id    │document_id  │vector_data  │  vector_hash    │ │ │
│  │  ├─────────┼─────────────┼─────────────┼─────────────────┤ │ │
│  │  │    1    │      1      │   [0.1,0.2] │   abc123...     │ │ │
│  │  │    2    │      2      │   [0.3,0.4] │   def456...     │ │ │
│  │  └─────────┴─────────────┴─────────────┴─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## ⚡ Производительность и оптимизация

### **Кэширование:**
```
┌─────────────────┐
│   Запрос        │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   Проверка      │
│   кэша          │
└─────────────────┘
    │
    ▼
┌─────┬─────┐
│Hit  │Miss │
└─────┴─────┘
    │     │
    ▼     ▼
┌─────┐ ┌─────────────────┐
│Воз- │ │ Обработка +     │
│врат │ │ сохранение в    │
│     │ │ кэш            │
└─────┘ └─────────────────┘
```

### **Асинхронная обработка:**
```
┌─────────────────┐
│   Запрос        │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   Параллельная  │
│   обработка     │
└─────────────────┘
    │
    ▼
┌─────┬─────┬─────┐
│Text │Vec  │Spec │
│Srch │Srch │Resp │
└─────┴─────┴─────┘
    │
    ▼
┌─────────────────┐
│   Объединение   │
│   результатов   │
└─────────────────┘
```

## 🔧 Мониторинг и логирование

### **Метрики системы:**
```
┌─────────────────────────────────────────────────────────────────┐
│                    МОНИТОРИНГ                                  │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Время         │  │   Память        │  │   CPU           │ │
│  │   обработки     │  │   использование │  │   нагрузка      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Количество    │  │   Успешность    │  │   Ошибки        │ │
│  │   запросов      │  │   поиска        │  │   системы       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 Заключение

**Rubin AI v2.0** использует современную микросервисную архитектуру с четким разделением ответственности:

- **Frontend** - интерактивный веб-интерфейс
- **API Gateway** - центральная точка входа и маршрутизации
- **Specialist Modules** - специализированные модули для разных областей
- **Database Layer** - гибридное хранилище (текст + векторы)
- **Search Engine** - интеллектуальный поиск с семантическим пониманием

**Поток данных** оптимизирован для максимальной производительности и качества ответов!

















