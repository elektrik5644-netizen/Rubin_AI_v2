<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Rubin IDE - v2.1 (LocalAI Ready)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #2d2d30;
            border-right: 1px solid #3e3e42;
            overflow-y: auto;
            padding: 10px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .editor-container {
            flex: 1;
            display: flex;
            position: relative;
        }

        .line-numbers {
            width: 50px;
            background: #2d2d30;
            border-right: 1px solid #3e3e42;
            padding: 10px 5px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            color: #858585;
            text-align: right;
            user-select: none;
            overflow-y: auto;
        }

        .code-editor {
            flex: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            outline: none;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 10px;
            resize: none;
            overflow-y: auto;
            white-space: pre;
            tab-size: 4;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2;
            caret-color: #d4d4d4;
            margin: 0;
            box-sizing: border-box;
        }

        .code-editor::selection {
            background: rgba(0, 120, 215, 0.3);
            color: #d4d4d4;
        }

        .code-editor::-moz-selection {
            background: rgba(0, 120, 215, 0.3);
            color: #d4d4d4;
        }

        .code-editor-container {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ */
        .syntax-highlight {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1e1e1e;
            pointer-events: none;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 10px;
            white-space: pre;
            overflow: hidden;
            z-index: 1;
            color: #d4d4d4;
            margin: 0;
            box-sizing: border-box;
        }

        .syntax-highlight .keyword { 
            color: #569cd6; 
            font-weight: bold;
        }
        
        .syntax-highlight .string { 
            color: #ce9178; 
        }
        
        .syntax-highlight .comment { 
            color: #6a9955; 
            font-style: italic;
        }
        
        .syntax-highlight .number { 
            color: #d7ba7d; 
            font-weight: bold;
        }
        
        .syntax-highlight .function { 
            color: #dcdcaa; 
        }
        
        .syntax-highlight .variable { 
            color: #9cdcfe; 
        }
        
        .syntax-highlight .operator { 
            color: #d4d4d4; 
        }
        
        .syntax-highlight .plc-keyword { 
            color: #569cd6; 
            font-weight: bold;
        }
        
        .syntax-highlight .plc-function { 
            color: #4ec9b0; 
        }
        
        .syntax-highlight .plc-address { 
            color: #d7ba7d; 
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ */
        .syntax-highlight-temp .keyword { 
            color: #569cd6; 
            font-weight: bold;
        }
        
        .syntax-highlight-temp .string { 
            color: #ce9178; 
        }
        
        .syntax-highlight-temp .comment { 
            color: #6a9955; 
            font-style: italic;
        }
        
        .syntax-highlight-temp .number { 
            color: #d7ba7d; 
            font-weight: bold;
        }
        
        .syntax-highlight-temp .function { 
            color: #dcdcaa; 
        }
        
        .syntax-highlight-temp .variable { 
            color: #9cdcfe; 
        }
        
        .syntax-highlight-temp .operator { 
            color: #d4d4d4; 
        }
        
        .syntax-highlight-temp .plc-keyword { 
            color: #569cd6; 
            font-weight: bold;
        }
        
        .syntax-highlight-temp .plc-function { 
            color: #4ec9b0; 
        }
        
        .syntax-highlight-temp .plc-address { 
            color: #d7ba7d; 
        }

        .chat-panel {
            width: 300px;
            background: #2d2d30;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #007acc;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            max-width: 100%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background: #007acc;
            color: white;
            margin-left: 20px;
        }

        .chat-message.ai {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            margin-right: 20px;
        }

        .chat-message.error {
            background: #dc3545;
            color: white;
            margin-right: 20px;
        }

        .chat-input-container {
            padding: 10px;
            border-top: 1px solid #3e3e42;
        }

        .chat-input-row {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .chat-input {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 8px;
            border-radius: 3px;
            outline: none;
        }

        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn:hover {
            background: #005a9e;
        }

        .btn.active {
            background: #28a745;
        }

        .file-item {
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            margin-bottom: 2px;
        }

        .file-item:hover {
            background: #3e3e42;
        }

        .status-bar {
            background: #007acc;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-indicator.offline {
            background: #dc3545;
        }

        .status-indicator.connecting {
            background: #ffc107;
        }

        .error-details {
            background: #dc3545;
            color: white;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .retry-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
        }

        .offline-mode {
            background: #ffc107;
            color: #000;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <h3>üìÅ –§–∞–π–ª—ã</h3>
            <div class="file-item" onclick="openFileInEditor('test_request.json')">üìÑ test_request.json</div>
            <div class="file-item" onclick="openFileInEditor('requirements.txt')">üìÑ requirements.txt</div>
            <div class="file-item" onclick="openFileInEditor('rubin_web_search.py')">üêç rubin_web_search.py</div>
            <div class="file-item" onclick="openFileInEditor('README_RUBIN_SELF_DEVELOPMENT.md')">üìö README</div>
            
            <h3 style="margin-top: 20px;">üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
            <div class="file-item" onclick="testConnection()">üîå –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>
            <div class="file-item" onclick="clearChat()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</div>
            <div class="file-item" onclick="toggleOfflineMode()">üåê –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º</div>
            
            <h3 style="margin-top: 20px;">üìö –î–æ–∫—É–º–µ–Ω—Ç—ã</h3>
            <div class="file-item" onclick="window.open('RubinFileUpload.html', '_blank')">üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
            <div class="file-item" onclick="searchDocuments()">üîç –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ</div>
    </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="main-content">
    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
    <div class="toolbar">
                <button class="btn" onclick="newFile()">üìÑ –ù–æ–≤—ã–π</button>
                <button class="btn" onclick="openFile()">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
                <button class="btn" onclick="saveFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn" onclick="runCode()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                <button class="btn" onclick="formatCode()">‚ú® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn" onclick="uploadToDatabase()">üìö –í –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
                <input type="file" id="fileUploadInput" style="display: none;" multiple accept=".py,.md,.json,.html,.txt,.sql,.log,.yaml,.yml,.xml,.csv,.plc,.st,.iec,.cfg,.ini,.conf,.config,.pmac,.gcode,.nc" onchange="uploadSelectedFiles()">
                <input type="file" id="folderUploadInput" style="display: none;" webkitdirectory directory multiple onchange="uploadSelectedFolder()">
                <input type="file" id="folderUploadInputAlt" style="display: none;" multiple accept=".py,.md,.json,.html,.txt,.sql,.log,.yaml,.yml,.xml,.csv,.plc,.st,.iec,.cfg,.ini,.conf,.config,.pmac,.gcode,.nc" onchange="uploadSelectedFilesAsProject()">
                <button class="btn" onclick="openFilesOrFolder()">üìÅ –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª—ã/–ø–∞–ø–∫—É</button>
                <button class="btn" onclick="analyzeCurrentFile()">üîç –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞</button>
                        </div>

            <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞ -->
            <div class="editor-container">
                <div class="line-numbers" id="line-numbers">1</div>
                <div class="code-editor-container">
                    <textarea class="code-editor" id="code-editor" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∑–¥–µ—Å—å..."># Rubin IDE - –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
# –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

print("üöÄ Rubin IDE –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
def check_connection():
    try:
        # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API
        import requests
        response = requests.get('http://localhost:8083/api/health', timeout=5)
        return response.status_code == 200
    except:
        return False

if check_connection():
    print("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å API —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
else:
    print("‚ö†Ô∏è API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–µ")
</textarea>
                    <div id="syntax-highlight" class="syntax-highlight" style="display: none;"></div>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
            <div class="status-bar">
                <div class="connection-status">
                    <div class="status-indicator" id="status-indicator"></div>
                    <span id="status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</span>
                        </div>
                <div>Rubin IDE v2.0 - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</div>
                        </div>
                        </div>

        <!-- –ü–∞–Ω–µ–ª—å —á–∞—Ç–∞ -->
        <div class="chat-panel">
            <div class="chat-header">
                ü§ñ Rubin AI Chat
        </div>

            <div class="chat-messages" id="chat-messages">
                <div class="chat-message ai">
                    –ü—Ä–∏–≤–µ—Ç! –Ø Rubin AI. –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-row">
                    <input type="text" class="chat-input" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleChatKeyPress(event)">
                    <button class="btn" onclick="sendChatMessage()">üì§</button>
                    <button class="btn" id="voice-btn" onclick="toggleVoiceInput()">üé§</button>
                    <button class="btn" id="tts-btn" onclick="toggleAutoTTS()">üîä</button>
                    <button class="btn" onclick="uploadCurrentTextToDatabase()">üìù –¢–µ–∫—Å—Ç –≤ –±–∞–∑—É</button>
            </div>
                <div class="chat-input-row">
                    <button class="btn" onclick="sendSystemMessage()">üîß –°–∏—Å—Ç–µ–º–∞</button>
                    <button class="btn" onclick="sendHelpMessage()">‚ùì –ü–æ–º–æ—â—å</button>
                    <button class="btn" onclick="testLocalResponse()">üß™ –¢–µ—Å—Ç</button>
                    <button class="btn" onclick="uploadToDatabase()">üìö –í –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
                    </div>
                <div class="chat-input-row">
                    <button class="btn" onclick="uploadLastMessageToDatabase()">üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–∞–∑—É</button>
                    <button class="btn" onclick="searchDocuments()">üîç –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ</button>
                    <button class="btn" onclick="showDatabaseStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã</button>
                    <button class="btn" onclick="showSystemStats()">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let autoTTS = false;
        let recognition = null;
        let isOfflineMode = false;
        let connectionRetries = 0;
        const maxRetries = 3;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            updateLineNumbers();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
            applySyntaxHighlighting('welcome.py');
            
            // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            updateConnectionStatus('connecting');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            testConnection();
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–æ–∫
            document.getElementById('code-editor').addEventListener('input', updateLineNumbers);
            document.getElementById('code-editor').addEventListener('scroll', syncScroll);
        });

        // –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        function updateLineNumbers() {
            const editor = document.getElementById('code-editor');
            const lineNumbers = document.getElementById('line-numbers');
            const lines = editor.value.split('\n');
            
            lineNumbers.innerHTML = '';
            for (let i = 1; i <= lines.length; i++) {
                lineNumbers.innerHTML += i + '<br>';
            }
        }

        function syncScroll() {
            const editor = document.getElementById('code-editor');
            const lineNumbers = document.getElementById('line-numbers');
            lineNumbers.scrollTop = editor.scrollTop;
        }

        function newFile() {
            document.getElementById('code-editor').value = '';
            updateLineNumbers();
        }

        function openFile() {
            // –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            document.getElementById('fileUploadInput').click();
        }

        function openFilesOrFolder() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∑–∞–≥—Ä—É–∑–∫–∏
            const choice = confirm('üìÅ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–≥—Ä—É–∑–∫–∏:\n\n' +
                'OK - –í—ã–±—Ä–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã\n' +
                '–û—Ç–º–µ–Ω–∞ - –í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É —Ü–µ–ª–∏–∫–æ–º');
            
            if (choice) {
                // –í—ã–±–æ—Ä –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                document.getElementById('fileUploadInput').click();
            } else {
                // –í—ã–±–æ—Ä –ø–∞–ø–∫–∏
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É webkitdirectory
                    if (document.getElementById('folderUploadInput').webkitdirectory !== undefined) {
                        document.getElementById('folderUploadInput').click();
                    } else {
                        // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ webkitdirectory
                        const useAlt = confirm('üìÅ –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –ø–∞–ø–æ–∫.\n\n' +
                            '–ú–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –∫–∞–∫ –ø—Ä–æ–µ–∫—Ç:\n\n' +
                            'OK - –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã –∫–∞–∫ –ø—Ä–æ–µ–∫—Ç\n' +
                            '–û—Ç–º–µ–Ω–∞ - –û—Ç–º–µ–Ω–∞');
                        
                        if (useAlt) {
                            document.getElementById('folderUploadInputAlt').click();
                        }
                    }
                } catch (error) {
                    alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–ø–∫–∏.\n\n' +
                        '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n' +
                        '1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Chrome –∏–ª–∏ Edge\n' +
                        '2. –í—ã–±—Ä–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã\n' +
                        '3. –û–±–Ω–æ–≤–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä');
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–ø–∫–∏:', error);
                }
            }
        }

        function uploadSelectedFilesAsProject() {
            const fileInput = document.getElementById('folderUploadInputAlt');
            const files = fileInput.files;
            
            if (files.length === 0) {
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–µ–∫—Ç –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            currentProjectFiles = Array.from(files);
            currentProjectName = '–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
            appendChatMessage('user', `üìÅ –°–æ–∑–¥–∞–Ω –ø—Ä–æ–µ–∫—Ç "${currentProjectName}" –∏–∑ ${files.length} —Ñ–∞–π–ª–æ–≤`);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
            loadProjectInEditor(files);

            // –û—á–∏—â–∞–µ–º input
            fileInput.value = '';
        }

        function saveFile() {
            const content = document.getElementById('code-editor').value;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rubin_code.py';
            a.click();
            URL.revokeObjectURL(url);
        }

        function runCode() {
            const code = document.getElementById('code-editor').value;
            try {
                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python
                if (code.includes('print(') || code.includes('def ') || code.includes('import ')) {
                    appendChatMessage('ai', '‚úÖ –ö–æ–¥ –≤—ã–≥–ª—è–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! –î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Python –∫–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª –∏–ª–∏ IDE.');
                } else {
                    appendChatMessage('ai', '‚ö†Ô∏è –ö–æ–¥ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç Python –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π');
                }
            } catch (e) {
                appendChatMessage('error', `–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞: ${e.message}`);
            }
        }

        function formatCode() {
            const editor = document.getElementById('code-editor');
            let code = editor.value;
            
            // –ü—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            code = code.replace(/\n{3,}/g, '\n\n'); // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            code = code.trim(); // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
            
            editor.value = code;
            updateLineNumbers();
            appendChatMessage('ai', '‚ú® –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω');
        }

        // –§—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã –∑–∞–≥—Ä—É–∑–∫–∏
            if (text.toLowerCase().includes('–∑–∞–≥—Ä—É–∑–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö') || 
                text.toLowerCase().includes('–∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É')) {
                uploadToDatabase();
                input.value = '';
                return;
            }
            
            appendChatMessage('user', text);
            input.value = '';

            if (isOfflineMode) {
                // –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º - –ª–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
                const response = generateOfflineResponse(text);
                appendChatMessage('ai', response);
                if (autoTTS) speak(response);
                return;
            }

            try {
                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API
                console.log('üîç –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å:', text);
                console.log('üåê URL:', 'http://localhost:8080/api/chat');
                
                const resp = await fetch('http://localhost:8080/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text }),
                    timeout: 10000
                });
                
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                
                const data = await resp.json();
                console.log('üì° –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', data);
                console.log('üéØ –ö–∞—Ç–µ–≥–æ—Ä–∏—è:', data.category);
                console.log('üñ•Ô∏è –°–µ—Ä–≤–µ—Ä:', data.server);
                
                const answer = data.response || '[–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç]';
                appendChatMessage('ai', answer);
                if (autoTTS) speak(answer);
                
                // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                connectionRetries = 0;
                updateConnectionStatus('connected');
                
            } catch (e) {
                connectionRetries++;
                
                if (connectionRetries >= maxRetries) {
                    appendChatMessage('error', `–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ ${maxRetries} –ø–æ–ø—ã—Ç–æ–∫. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º.`);
                    enableOfflineMode();
                } else {
                    appendChatMessage('error', `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–ø—ã—Ç–∫–∞ ${connectionRetries}/${maxRetries}): ${e.message}`);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
                    setTimeout(() => {
                        appendChatMessage('ai', 'üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
                        sendChatMessage();
                    }, 2000);
                }
            }
        }

        function generateOfflineResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('–ø—Ä–∏–≤–µ—Ç') || lowerMessage.includes('hello')) {
                return '–ü—Ä–∏–≤–µ—Ç! –Ø —Ä–∞–±–æ—Ç–∞—é –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–µ. –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –±–∞–∑–æ–≤—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é.';
            }
            
            if (lowerMessage.includes('python') || lowerMessage.includes('–∫–æ–¥')) {
                return 'Python - –æ—Ç–ª–∏—á–Ω—ã–π —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è! –í–æ—Ç –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä:\n\n```python\nprint("Hello, World!")\n```';
            }
            
            if (lowerMessage.includes('–æ—à–∏–±–∫–∞') || lowerMessage.includes('error')) {
                return '–î–ª—è —Ä–µ—à–µ–Ω–∏—è –æ—à–∏–±–æ–∫:\n1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å\n2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–æ–≤\n3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\n4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ try-except –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏';
            }
            
            if (lowerMessage.includes('–ø–æ–º–æ—â—å') || lowerMessage.includes('help')) {
                return '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n- üîß –°–∏—Å—Ç–µ–º–∞: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ\n- ‚ùì –ü–æ–º–æ—â—å: —Å–ø—Ä–∞–≤–∫–∞\n- üß™ –¢–µ—Å—Ç: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π';
            }
            
            return '–ò–∑–≤–∏–Ω–∏—Ç–µ, —è —Ä–∞–±–æ—Ç–∞—é –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã.';
        }

        function sendSystemMessage() {
            const systemInfo = `
üîß –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ:
- –ë—Ä–∞—É–∑–µ—Ä: ${navigator.userAgent}
- –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${navigator.platform}
- –Ø–∑—ã–∫: ${navigator.language}
- –†–µ–∂–∏–º: ${isOfflineMode ? '–û—Ñ–ª–∞–π–Ω' : '–û–Ω–ª–∞–π–Ω'}
- –ü–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${connectionRetries}/${maxRetries}
- –°—Ç–∞—Ç—É—Å: ${document.getElementById('status-text').textContent}
            `;
            appendChatMessage('ai', systemInfo);
        }

        function sendHelpMessage() {
            const help = `
‚ùì –°–ø—Ä–∞–≤–∫–∞ –ø–æ Rubin IDE:

üìù –†–µ–¥–∞–∫—Ç–æ—Ä:
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: Ctrl+N
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å: Ctrl+S
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–¥: F5

üí¨ –ß–∞—Ç:
- Enter: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
- üé§: –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
- üîä: —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ

üîß –°–∏—Å—Ç–µ–º–∞:
- –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤

üåê API: http://localhost:8083
            `;
            appendChatMessage('ai', help);
        }

        function testLocalResponse() {
            appendChatMessage('ai', 'üß™ –¢–µ—Å—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:\n‚úÖ –†–µ–¥–∞–∫—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç\n‚úÖ –ß–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç\n‚úÖ –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–µ–Ω\n‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç\n‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç');
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
            const editor = document.getElementById('code-editor');
            if (editor) {
                appendChatMessage('ai', '‚úÖ –†–µ–¥–∞–∫—Ç–æ—Ä –Ω–∞–π–¥–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω');
            } else {
                appendChatMessage('error', '‚ùå –†–µ–¥–∞–∫—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            }
        }

        function appendChatMessage(type, message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function clearChat() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '<div class="chat-message ai">–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>';
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function testConnection() {
            try {
                const response = await fetch('http://localhost:8080/api/health', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    updateConnectionStatus('connected');
                    connectionRetries = 0;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (e) {
                updateConnectionStatus('offline');
                appendChatMessage('error', `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API: ${e.message}`);
                enableOfflineMode();
            }
        }

        function updateConnectionStatus(status) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            indicator.className = `status-indicator ${status}`;
            
            switch (status) {
                case 'connected':
                    statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    break;
                case 'connecting':
                    statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    break;
                case 'offline':
                    statusText.textContent = '–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º';
                    break;
            }
        }

        function enableOfflineMode() {
            isOfflineMode = true;
            updateConnectionStatus('offline');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–µ
            const offlineNotice = document.createElement('div');
            offlineNotice.className = 'offline-mode';
            offlineNotice.innerHTML = `
                üåê –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω<br>
                API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏<br>
                <button class="retry-button" onclick="testConnection()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
            `;
            
            document.getElementById('chat-messages').appendChild(offlineNotice);
        }

        function toggleOfflineMode() {
            if (isOfflineMode) {
                isOfflineMode = false;
                testConnection();
                appendChatMessage('ai', 'üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º...');
            } else {
                enableOfflineMode();
                appendChatMessage('ai', 'üåê –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
            }
        }

        function searchDocuments() {
            const query = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:');
            if (query) {
                appendChatMessage('user', `üîç –ü–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: "${query}"`);
                searchDocumentsInDatabase(query);
            }
        }

        async function searchDocumentsInDatabase(query) {
            try {
                const response = await fetch('http://localhost:8088/api/documents/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        limit: 5
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    const documents = result.data.results;
                    if (documents.length > 0) {
                        let message = `üîç –ù–∞–π–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${documents.length}\n\n`;
                        documents.forEach((doc, index) => {
                            message += `${index + 1}. **${doc.filename}**\n`;
                            message += `   üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${doc.category}\n`;
                            message += `   üè∑Ô∏è –¢–µ–≥–∏: ${doc.tags.join(', ')}\n`;
                            message += `   üìä –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${doc.relevance}\n`;
                            message += `   üìÑ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä: ${doc.content.substring(0, 100)}...\n\n`;
                        });
                        appendChatMessage('assistant', message);
                    } else {
                        appendChatMessage('assistant', 'üîç –î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.');
                    }
                } else {
                    appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${result.message}`);
                }
            } catch (error) {
                appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${error.message}`);
            }
        }

        function uploadToDatabase() {
            const content = document.getElementById('code-editor').value;
            if (!content.trim()) {
                alert('–†–µ–¥–∞–∫—Ç–æ—Ä –ø—É—Å—Ç. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            const filename = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞:', 'document.txt');
            if (!filename) return;

            const category = prompt('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:\n1. python_code\n2. documentation\n3. configuration\n4. industrial_automation\n5. artificial_intelligence\n6. api_documentation\n7. tutorial\n8. general\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ:', '');
            if (category === null) return;

            const tags = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):', '');
            if (tags === null) return;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            uploadContentToDatabase(filename, content, category, tags);
        }

        function uploadLastMessageToDatabase() {
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞
            const chatMessages = document.getElementById('chat-messages');
            const userMessages = chatMessages.querySelectorAll('.chat-message.user');
            
            if (userMessages.length === 0) {
                alert('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.');
                return;
            }
            
            const lastMessage = userMessages[userMessages.length - 1];
            const content = lastMessage.textContent.trim();
            
            if (!content) {
                alert('–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ.');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            const filename = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞:', 'chat_message.txt');
            if (!filename) return;

            const category = prompt('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:\n1. python_code\n2. documentation\n3. configuration\n4. industrial_automation\n5. artificial_intelligence\n6. api_documentation\n7. tutorial\n8. general\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ:', 'general');
            if (category === null) return;

            const tags = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):', 'chat, message, user');
            if (tags === null) return;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            uploadContentToDatabase(filename, content, category, tags);
        }

        function uploadCurrentTextToDatabase() {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
            const chatInput = document.getElementById('chat-input');
            const content = chatInput.value.trim();
            
            if (!content) {
                alert('–ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø—É—Å—Ç–æ–µ. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            const filename = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞:', 'input_text.txt');
            if (!filename) return;

            const category = prompt('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:\n1. python_code\n2. documentation\n3. configuration\n4. industrial_automation\n5. artificial_intelligence\n6. api_documentation\n7. tutorial\n8. general\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ:', 'general');
            if (category === null) return;

            const tags = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):', 'input, text, user');
            if (tags === null) return;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            uploadContentToDatabase(filename, content, category, tags);
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            chatInput.value = '';
        }

        async function uploadSelectedFiles() {
            const fileInput = document.getElementById('fileUploadInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è
            const action = confirm(`üìÅ –í—ã–±—Ä–∞–Ω–æ ${files.length} —Ñ–∞–π–ª(–æ–≤).\n\n` +
                `–ù–∞–∂–º–∏—Ç–µ OK –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ\n` +
                `–ù–∞–∂–º–∏—Ç–µ –û—Ç–º–µ–Ω–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Rubin AI`);

            if (action) {
                // –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                loadFilesInEditor(files);
            } else {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                await uploadFilesToDatabase(files);
            }

            // –û—á–∏—â–∞–µ–º input
            fileInput.value = '';
        }

        async function uploadFilesToDatabase(files) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            const category = prompt('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:\n1. python_code\n2. documentation\n3. configuration\n4. industrial_automation\n5. artificial_intelligence\n6. api_documentation\n7. tutorial\n8. general\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ:', 'general');
            if (category === null) {
                return;
            }

            const tags = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):', 'uploaded, files');
            if (tags === null) {
                return;
            }

            const tagList = tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã
            for (const file of files) {
                try {
                    appendChatMessage('user', `üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞: ${file.name}`);
                    
                    // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('category', category);
                    formData.append('tags', tagList.join(','));
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ API
                    const response = await fetch('http://localhost:8088/api/documents/upload-file', {
                    method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        let message = `‚úÖ –§–∞–π–ª "${file.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!\n\n`;
                        message += `üìÑ **–ò–º—è —Ñ–∞–π–ª–∞:** ${result.data.filename}\n`;
                        message += `üÜî **ID –¥–æ–∫—É–º–µ–Ω—Ç–∞:** ${result.data.document_id}\n`;
                        message += `üìÇ **–ö–∞—Ç–µ–≥–æ—Ä–∏—è:** ${result.data.category}\n`;
                        message += `üè∑Ô∏è **–¢–µ–≥–∏:** ${result.data.tags.join(', ')}\n`;
                        message += `üìä **–†–∞–∑–º–µ—Ä:** ${result.data.file_size} –±–∞–π—Ç\n`;
                        message += `üìù **–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:** ${result.data.content_length} —Å–∏–º–≤–æ–ª–æ–≤\n\n`;
                        message += `–¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!`;
                        
                        appendChatMessage('assistant', message);
                        } else {
                        appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ "${file.name}": ${result.message}`);
                    }
                } catch (error) {
                    appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ "${file.name}": ${error.message}`);
                }
            }
        }

        function loadFilesInEditor(files) {
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const textExtensions = ['.py', '.js', '.html', '.css', '.json', '.md', '.txt', '.xml', '.yaml', '.yml', '.sql', '.log', '.csv', '.plc', '.st', '.iec', '.cfg', '.ini', '.conf', '.config', '.pmac', '.gcode', '.nc'];
            const editableFiles = Array.from(files).filter(file => {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                return textExtensions.includes(ext);
            });

            if (editableFiles.length === 0) {
                const allExtensions = Array.from(files).map(f => '.' + f.name.split('.').pop().toLowerCase());
                const uniqueExtensions = [...new Set(allExtensions)];
                
                alert(`–°—Ä–µ–¥–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.\n\n` +
                    `–ù–∞–π–¥–µ–Ω—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è: ${uniqueExtensions.join(', ')}\n\n` +
                    `–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: .py, .js, .html, .css, .json, .md, .txt, .xml, .yaml, .yml, .sql, .log, .csv, .plc, .st, .iec, .cfg, .ini, .conf, .config, .pmac, .gcode, .nc`);
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å —Å —Ñ–∞–π–ª–∞–º–∏
            updateFilesSidebar(editableFiles);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
            if (editableFiles.length > 0) {
                loadFileInEditor(editableFiles[0]);
            }

            appendChatMessage('ai', `üìÅ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${editableFiles.length} —Ñ–∞–π–ª(–æ–≤) –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä!\n` +
                `üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏`);
        }

        function updateFilesSidebar(files) {
            const sidebar = document.querySelector('.sidebar');
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
            const oldFiles = sidebar.querySelectorAll('.loaded-file');
            const oldHeaders = sidebar.querySelectorAll('.files-header');
            oldFiles.forEach(file => file.remove());
            oldHeaders.forEach(header => header.remove());

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const filesHeader = document.createElement('h3');
            filesHeader.className = 'files-header';
            filesHeader.textContent = `üìÅ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã`;
            filesHeader.style.marginTop = '20px';
            filesHeader.style.color = '#007acc';
            filesHeader.style.borderBottom = '1px solid #3e3e42';
            filesHeader.style.paddingBottom = '5px';
            sidebar.appendChild(filesHeader);

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ñ–∞–π–ª–æ–≤
            const infoDiv = document.createElement('div');
            infoDiv.className = 'files-header';
            infoDiv.textContent = `üìä –§–∞–π–ª–æ–≤: ${files.length}`;
            infoDiv.style.fontSize = '12px';
            infoDiv.style.color = '#858585';
            infoDiv.style.marginBottom = '10px';
            sidebar.appendChild(infoDiv);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item loaded-file';
                fileItem.textContent = `üìÑ ${file.name}`;
                fileItem.style.cursor = 'pointer';
                fileItem.onclick = () => {
                    console.log('–ö–ª–∏–∫ –ø–æ —Ñ–∞–π–ª—É:', file.name);
                    loadFileInEditor(file);
                };
                fileItem.onmouseover = () => fileItem.style.backgroundColor = '#3e3e42';
                fileItem.onmouseout = () => fileItem.style.backgroundColor = '';
                sidebar.appendChild(fileItem);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
            const clearButton = document.createElement('div');
            clearButton.className = 'file-item files-header';
            clearButton.textContent = 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã';
            clearButton.style.color = '#dc3545';
            clearButton.style.cursor = 'pointer';
            clearButton.style.marginTop = '10px';
            clearButton.style.borderTop = '1px solid #3e3e42';
            clearButton.style.paddingTop = '10px';
            clearButton.onclick = () => clearLoadedFiles();
            sidebar.appendChild(clearButton);
        }

        function clearLoadedFiles() {
            if (confirm('üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã?')) {
                // –û—á–∏—â–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å
                const oldFiles = document.querySelectorAll('.loaded-file');
                const oldHeaders = document.querySelectorAll('.files-header');
                oldFiles.forEach(file => file.remove());
                oldHeaders.forEach(header => header.remove());
                
                // –û—á–∏—â–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                document.getElementById('code-editor').value = '';
                updateLineNumbers();
                
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –±–∞—Ä
                const projectInfo = document.querySelector('.project-info');
                if (projectInfo) {
                    projectInfo.remove();
                }
                
                appendChatMessage('ai', 'üóëÔ∏è –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã');
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–µ–∫—Ç–æ–º
        let currentProjectFiles = [];
        let currentProjectName = '';

        async function uploadSelectedFolder() {
            const folderInput = document.getElementById('folderUploadInput');
            const files = folderInput.files;
            
            if (files.length === 0) {
                appendChatMessage('error', '‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞');
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã
            currentProjectFiles = Array.from(files);
            currentProjectName = files[0].webkitRelativePath ? 
                files[0].webkitRelativePath.split('/')[0] : '–ü—Ä–æ–µ–∫—Ç';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –ø–∞–ø–∫–µ
            appendChatMessage('user', `üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–∞–ø–∫–∞ "${currentProjectName}" —Å ${files.length} —Ñ–∞–π–ª–∞–º–∏`);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è
            const action = confirm(`üìÇ –û—Ç–∫—Ä—ã—Ç–∞ –ø–∞–ø–∫–∞ "${currentProjectName}" —Å ${files.length} —Ñ–∞–π–ª–∞–º–∏.\n\n` +
                `–ù–∞–∂–º–∏—Ç–µ OK –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ\n` +
                `–ù–∞–∂–º–∏—Ç–µ –û—Ç–º–µ–Ω–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Rubin AI`);

            if (action) {
                // –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                loadProjectInEditor(files);
            } else {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                await uploadFolderToDatabase(files);
            }

            // –û—á–∏—â–∞–µ–º input
            folderInput.value = '';
        }

        function clearProject() {
            if (confirm('üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç?')) {
                // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
                currentProjectFiles = [];
                currentProjectName = '';
                
                // –û—á–∏—â–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å
                const oldProjectFiles = document.querySelectorAll('.project-file');
                const oldProjectHeaders = document.querySelectorAll('.project-header');
                oldProjectFiles.forEach(file => file.remove());
                oldProjectHeaders.forEach(header => header.remove());
                
                // –û—á–∏—â–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                document.getElementById('code-editor').value = '';
                updateLineNumbers();
                
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –±–∞—Ä
                const projectInfo = document.querySelector('.project-info');
                if (projectInfo) {
                    projectInfo.remove();
                }
                
                appendChatMessage('ai', 'üóëÔ∏è –ü—Ä–æ–µ–∫—Ç –æ—á–∏—â–µ–Ω');
            }
        }

        async function uploadFolderToDatabase(files) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            const category = prompt('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤:\n1. python_code\n2. documentation\n3. configuration\n4. industrial_automation\n5. artificial_intelligence\n6. api_documentation\n7. tutorial\n8. general\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ:', 'general');
            if (category === null) {
                return;
            }

            const tags = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):', 'folder, uploaded, batch');
            if (tags === null) {
                return;
            }

            const tagList = tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã
            const supportedExtensions = ['.py', '.md', '.json', '.html', '.txt', '.sql', '.log', '.yaml', '.yml', '.xml', '.csv'];
            const supportedFiles = Array.from(files).filter(file => {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                return supportedExtensions.includes(ext);
            });

            if (supportedFiles.length === 0) {
                alert('–í –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ –Ω–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤.\n–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: .py, .md, .json, .html, .txt, .sql, .log, .yaml, .yml, .xml, .csv');
                return;
            }

            appendChatMessage('user', `üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–ø–∫–∏: ${supportedFiles.length} —Ñ–∞–π–ª–æ–≤`);

            let successCount = 0;
            let errorCount = 0;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –ø–æ –æ–¥–Ω–æ–º—É
            for (const file of supportedFiles) {
                try {
                    // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('category', category);
                    formData.append('tags', tagList.join(','));
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ API
                    const response = await fetch('http://localhost:8088/api/documents/upload-file', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        successCount++;
                        appendChatMessage('assistant', `‚úÖ ${file.name} –∑–∞–≥—Ä—É–∂–µ–Ω (ID: ${result.data.document_id})`);
                    } else {
                        errorCount++;
                        appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}: ${result.message}`);
                    }
                } catch (error) {
                    errorCount++;
                    appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${file.name}: ${error.message}`);
                }
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            let summaryMessage = `üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–ø–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n`;
            summaryMessage += `‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${successCount} —Ñ–∞–π–ª–æ–≤\n`;
            summaryMessage += `‚ùå –û—à–∏–±–æ–∫: ${errorCount} —Ñ–∞–π–ª–æ–≤\n`;
            summaryMessage += `üìä –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${supportedFiles.length} —Ñ–∞–π–ª–æ–≤\n\n`;
            summaryMessage += `üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}\n`;
            summaryMessage += `üè∑Ô∏è –¢–µ–≥–∏: ${tagList.join(', ')}\n\n`;
            summaryMessage += `–í—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!`;
            
            appendChatMessage('assistant', summaryMessage);
        }

        function loadProjectInEditor(files) {
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:', {
                totalFiles: files.length,
                projectName: currentProjectName,
                files: Array.from(files).map(f => ({
                    name: f.name,
                    size: f.size,
                    type: f.type,
                    webkitRelativePath: f.webkitRelativePath
                }))
            });

            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const textExtensions = ['.py', '.js', '.html', '.css', '.json', '.md', '.txt', '.xml', '.yaml', '.yml', '.sql', '.log', '.csv', '.plc', '.st', '.iec', '.cfg', '.ini', '.conf', '.config', '.pmac', '.gcode', '.nc'];
            const editableFiles = Array.from(files).filter(file => {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                return textExtensions.includes(ext);
            });

            console.log('–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:', editableFiles.length);

            if (editableFiles.length === 0) {
                const allExtensions = Array.from(files).map(f => '.' + f.name.split('.').pop().toLowerCase());
                const uniqueExtensions = [...new Set(allExtensions)];
                
                alert(`–í –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.\n\n` +
                    `–ù–∞–π–¥–µ–Ω—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è: ${uniqueExtensions.join(', ')}\n\n` +
                    `–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: .py, .js, .html, .css, .json, .md, .txt, .xml, .yaml, .yml, .sql, .log, .csv, .plc, .st, .iec, .cfg, .ini, .conf, .config, .pmac, .gcode, .nc`);
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å —Å —Ñ–∞–π–ª–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–∞
            updateProjectSidebar(editableFiles);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
            if (editableFiles.length > 0) {
                loadFileInEditor(editableFiles[0]);
            }

            appendChatMessage('ai', `üìÇ –ü—Ä–æ–µ–∫—Ç "${currentProjectName}" –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä!\n` +
                `üìÑ –î–æ—Å—Ç—É–ø–Ω–æ —Ñ–∞–π–ª–æ–≤: ${editableFiles.length}\n` +
                `üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏`);
        }

        function updateProjectSidebar(files) {
            const sidebar = document.querySelector('.sidebar');
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
            const oldProjectFiles = sidebar.querySelectorAll('.project-file');
            const oldProjectHeaders = sidebar.querySelectorAll('.project-header');
            oldProjectFiles.forEach(file => file.remove());
            oldProjectHeaders.forEach(header => header.remove());

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞
            const projectHeader = document.createElement('h3');
            projectHeader.className = 'project-header';
            projectHeader.textContent = `üìÅ ${currentProjectName}`;
            projectHeader.style.marginTop = '20px';
            projectHeader.style.color = '#007acc';
            projectHeader.style.borderBottom = '1px solid #3e3e42';
            projectHeader.style.paddingBottom = '5px';
            sidebar.appendChild(projectHeader);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ñ–∞–π–ª–æ–≤
            const infoDiv = document.createElement('div');
            infoDiv.className = 'project-header';
            infoDiv.textContent = `üìä –§–∞–π–ª–æ–≤: ${files.length}`;
            infoDiv.style.fontSize = '12px';
            infoDiv.style.color = '#858585';
            infoDiv.style.marginBottom = '10px';
            sidebar.appendChild(infoDiv);

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ –ø–∞–ø–∫–∞–º
            const fileGroups = {};
            files.forEach(file => {
                const path = file.webkitRelativePath || file.name;
                const folder = path.includes('/') ? path.substring(0, path.lastIndexOf('/')) : '';
                
                if (!fileGroups[folder]) {
                    fileGroups[folder] = [];
                }
                fileGroups[folder].push(file);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å
            Object.keys(fileGroups).forEach(folder => {
                if (folder !== '') {
                    const folderHeader = document.createElement('div');
                    folderHeader.className = 'file-item project-file';
                    folderHeader.style.fontWeight = 'bold';
                    folderHeader.style.color = '#569cd6';
                    folderHeader.style.backgroundColor = '#2d2d30';
                    folderHeader.style.borderLeft = '3px solid #007acc';
                    folderHeader.textContent = `üìÅ ${folder}`;
                    sidebar.appendChild(folderHeader);
                }
                
                fileGroups[folder].forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item project-file';
                    fileItem.textContent = `üìÑ ${file.name}`;
                    fileItem.style.paddingLeft = folder !== '' ? '20px' : '10px';
                    fileItem.onclick = () => loadFileInEditor(file);
                    fileItem.onmouseover = () => fileItem.style.backgroundColor = '#3e3e42';
                    fileItem.onmouseout = () => fileItem.style.backgroundColor = '';
                    sidebar.appendChild(fileItem);
                });
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
            const clearButton = document.createElement('div');
            clearButton.className = 'file-item project-header';
            clearButton.textContent = 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç';
            clearButton.style.color = '#dc3545';
            clearButton.style.cursor = 'pointer';
            clearButton.style.marginTop = '10px';
            clearButton.style.borderTop = '1px solid #3e3e42';
            clearButton.style.paddingTop = '10px';
            clearButton.onclick = () => clearProject();
            sidebar.appendChild(clearButton);
        }

        function loadFileInEditor(file) {
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä:', {
                name: file.name,
                size: file.size,
                type: file.type
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
            if (file.size > 10 * 1024 * 1024) { // 10MB
                alert(`‚ö†Ô∏è –§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${(file.size / 1024 / 1024).toFixed(1)} MB).\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10 MB`);
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', {
                        length: content.length,
                        firstChars: content.substring(0, 100)
                    });

                    // –û—á–∏—â–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                    const editor = document.getElementById('code-editor');
                    if (editor) {
                        // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
                        resetSyntaxHighlighting();
                        
                        editor.value = content;
                        updateLineNumbers();
                        
                        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤ –Ω–∞—á–∞–ª–æ
                        editor.scrollTop = 0;
                        
                        console.log('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä');
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                        setTimeout(() => {
                            applySyntaxHighlighting(file.name);
                        }, 100);
                        
                    } else {
                        console.error('–†–µ–¥–∞–∫—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                        appendChatMessage('error', '‚ùå –û—à–∏–±–∫–∞: —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                    const statusBar = document.querySelector('.status-bar');
                    if (statusBar) {
                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
                        const oldProjectInfo = statusBar.querySelector('.project-info');
                        if (oldProjectInfo) {
                            oldProjectInfo.remove();
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                        const projectInfo = document.createElement('div');
                        projectInfo.className = 'project-info';
                        projectInfo.textContent = `üìÑ ${file.name} | üìÅ ${currentProjectName || '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞'}`;
                        statusBar.appendChild(projectInfo);
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —á–∞—Ç–µ
                    appendChatMessage('ai', `üìÑ –û—Ç–∫—Ä—ã—Ç —Ñ–∞–π–ª: ${file.name}\n` +
                        `üìä –†–∞–∑–º–µ—Ä: ${content.length} —Å–∏–º–≤–æ–ª–æ–≤\n` +
                        `üìù –°—Ç—Ä–æ–∫: ${content.split('\n').length}\n` +
                        `üí° –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞`);
                        
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', error);
                    appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${error.message}`);
                }
            };
            
            reader.onerror = function(e) {
                console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', e);
                appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${file.name}`);
            };
            
            // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ —Ç–µ–∫—Å—Ç
            reader.readAsText(file, 'UTF-8');
        }

        async function showDatabaseStats() {
            try {
                appendChatMessage('user', 'üìä –ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
                
                const response = await fetch('http://localhost:8088/api/documents/stats', {
                    method: 'GET'
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é, —Ç–∞–∫ –∫–∞–∫ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö –≤ –∫–æ—Ä–Ω–µ –æ–±—ä–µ–∫—Ç–∞
                    const stats = result;
                    let message = `üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ Rubin:**\n\n`;
                    
                    message += `**–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**\n`;
                    message += `‚Ä¢ **–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:** ${stats.total_documents || 0}\n`;
                    message += `‚Ä¢ **–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä:** ${stats.total_size_bytes || 0} –±–∞–π—Ç (${stats.total_size_mb || 0} –ú–ë)\n`;
                    message += `‚Ä¢ **–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä:** ${stats.average_size_bytes || 0} –±–∞–π—Ç\n`;
                    message += `‚Ä¢ **–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é:** ${stats.recent_documents_week || 0}\n\n`;
                    
                    if (stats.type_distribution && Object.keys(stats.type_distribution).length > 0) {
                        message += `**–ü–æ —Ç–∏–ø–∞–º —Ñ–∞–π–ª–æ–≤:**\n`;
                        for (const [fileType, count] of Object.entries(stats.type_distribution)) {
                            message += `‚Ä¢ **${fileType}:** ${count} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\n`;
                        }
                        message += `\n`;
                    }
                    
                    message += `**–î–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:**\n`;
                    message += `‚Ä¢ "–Ω–∞–π–¥–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ [–∑–∞–ø—Ä–æ—Å]"\n`;
                    message += `‚Ä¢ –ö–Ω–æ–ø–∫—É "üîç –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ" –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏\n`;
                    message += `‚Ä¢ –°—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–≥—Ä—É–∑–∫–∏: http://localhost:8083/RubinFileUpload.html\n`;
                    message += `‚Ä¢ –û–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã: http://localhost:8083/api/stats`;
                    
                    appendChatMessage('assistant', message);
                } else {
                    appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${result.error || result.message}`);
                }
            } catch (error) {
                appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
            }
        }

        async function showSystemStats() {
            try {
                appendChatMessage('user', 'üìä –ó–∞–ø—Ä–æ—Å –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã');
                
                const response = await fetch('http://localhost:8080/api/stats', {
                    method: 'GET'
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    const stats = result;
                    let message = `üìä **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã Rubin:**\n\n`;
                    
                    // –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    message += `**–°–∏—Å—Ç–µ–º–∞:**\n`;
                    message += `‚Ä¢ **–°—Ç–∞—Ç—É—Å:** ${stats.system?.status || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n`;
                    message += `‚Ä¢ **AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä:** ${stats.system?.ai_provider || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n`;
                    message += `‚Ä¢ **API –∫–ª—é—á:** ${stats.system?.api_key_configured ? '–Ω–∞—Å—Ç—Ä–æ–µ–Ω' : '–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}\n`;
                    message += `‚Ä¢ **–í—Ä–µ–º—è:** ${new Date(stats.system?.timestamp).toLocaleString()}\n\n`;
                    
                    // –î–æ–∫—É–º–µ–Ω—Ç—ã
                    message += `**–î–æ–∫—É–º–µ–Ω—Ç—ã:**\n`;
                    message += `‚Ä¢ **–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:** ${stats.documents?.total_count || 0}\n`;
                    message += `‚Ä¢ **–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä:** ${stats.documents?.total_size_mb || 0} –ú–ë\n`;
                    message += `‚Ä¢ **–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä:** ${stats.documents?.average_size_kb || 0} –ö–ë\n\n`;
                    
                    // –§–∞–π–ª—ã
                    message += `**–§–∞–π–ª—ã –≤ —Å–∏—Å—Ç–µ–º–µ:**\n`;
                    message += `‚Ä¢ **–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤:** ${stats.files?.total_files || 0}\n`;
                    if (stats.files?.by_extension) {
                        const topExtensions = Object.entries(stats.files.by_extension)
                            .sort(([,a], [,b]) => b - a)
                            .slice(0, 5);
                        message += `‚Ä¢ **–¢–æ–ø —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π:**\n`;
                        topExtensions.forEach(([ext, count]) => {
                            message += `  - ${ext || '–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è'}: ${count} —Ñ–∞–π–ª–æ–≤\n`;
                        });
                    }
                    message += `\n`;
                    
                    // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
                    message += `**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**\n`;
                    message += `‚Ä¢ **–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:** ${stats.database?.total_records || 0}\n`;
                    if (stats.database?.tables) {
                        message += `‚Ä¢ **–¢–∞–±–ª–∏—Ü—ã:**\n`;
                        Object.entries(stats.database.tables).forEach(([table, count]) => {
                            message += `  - ${table}: ${count} –∑–∞–ø–∏—Å–µ–π\n`;
                        });
                    }
                    
                    appendChatMessage('assistant', message);
                } else {
                    appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${result.error || result.message}`);
                }
            } catch (error) {
                appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã: ${error.message}`);
            }
        }


        async function uploadContentToDatabase(filename, content, category, tags) {
            try {
                appendChatMessage('user', `üìö –ó–∞–≥—Ä—É–∑–∫–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: ${filename}`);
                
                const response = await fetch('http://localhost:8088/api/documents/upload-content', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: filename,
                        content: content,
                        category: category,
                        tags: tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : []
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    const data = result.data;
                    let message = `‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!\n\n`;
                    message += `üìÑ **–ò–º—è —Ñ–∞–π–ª–∞:** ${data.filename}\n`;
                    message += `üÜî **ID –¥–æ–∫—É–º–µ–Ω—Ç–∞:** ${data.document_id}\n`;
                    message += `üìÇ **–ö–∞—Ç–µ–≥–æ—Ä–∏—è:** ${data.category}\n`;
                    message += `üè∑Ô∏è **–¢–µ–≥–∏:** ${data.tags.join(', ')}\n`;
                    message += `üìä **–†–∞–∑–º–µ—Ä:** ${data.file_size} –±–∞–π—Ç\n`;
                    message += `üìù **–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:** ${data.content_length} —Å–∏–º–≤–æ–ª–æ–≤\n\n`;
                    message += `–¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!`;
                    
                    appendChatMessage('assistant', message);
                    } else {
                    appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${result.message}`);
                }
            } catch (error) {
                appendChatMessage('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤
        function openFileInEditor(filename) {
            // –í —Ä–µ–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–æ –±—ã —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            appendChatMessage('ai', `üìÅ –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–∞: ${filename}\n\n–í –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.`);
        }

        // TTS —Ñ—É–Ω–∫—Ü–∏–∏
        function speak(text) {
            try {
                if (!('speechSynthesis' in window)) return;
                const utter = new SpeechSynthesisUtterance(text.replace(/[#*_`>]/g, ''));
                utter.lang = 'ru-RU';
                utter.rate = 1.0;
                utter.pitch = 1.0;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utter);
            } catch (e) {
                console.log('TTS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e);
            }
        }

        function toggleAutoTTS() {
            autoTTS = !autoTTS;
            const ttsBtn = document.getElementById('tts-btn');
            ttsBtn.style.background = autoTTS ? '#28a745' : '#007acc';
            appendChatMessage('ai', `üîä –ê–≤—Ç–æ–æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ: ${autoTTS ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ'}`);
        }

        // –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
        function toggleVoiceInput() {
            try {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SR) {
                    alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                    return;
                }
                
                if (recognition) {
                    recognition.stop();
                    recognition = null;
                    setVoiceBtnActive(false);
                    return;
                }
                
                recognition = new SR();
                recognition.lang = 'ru-RU';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                
                recognition.onresult = (e) => {
                    const transcript = e.results[0][0].transcript;
                    const input = document.getElementById('chat-input');
                    input.value = transcript;
                    setTimeout(sendChatMessage, 50);
                };
                
                recognition.onerror = () => {
                    setVoiceBtnActive(false);
                    recognition = null;
                };
                
                recognition.onend = () => {
                    setVoiceBtnActive(false);
                    recognition = null;
                };
                
                recognition.start();
                setVoiceBtnActive(true);
                
            } catch (e) {
                setVoiceBtnActive(false);
                recognition = null;
                appendChatMessage('error', `–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: ${e.message}`);
            }
        }

        function setVoiceBtnActive(active) {
            const micBtn = document.getElementById('voice-btn');
            micBtn.style.background = active ? '#28a745' : '#007acc';
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (—Ç–∏—Ö–æ)
        setInterval(() => {
            if (!isOfflineMode && connectionRetries < maxRetries) {
                // –¢–∏—Ö–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
                testConnectionQuiet();
            }
        }, 30000);
        
        // –¢–∏—Ö–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ)
        async function testConnectionQuiet() {
            try {
                const response = await fetch('http://localhost:8080/api/health', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    updateConnectionStatus('connected');
                    connectionRetries = 0;
                } else {
                    updateConnectionStatus('offline');
                }
            } catch (e) {
                updateConnectionStatus('offline');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–π —Ü–≤–µ—Ç–Ω–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
        function resetSyntaxHighlighting() {
            const highlightDiv = document.getElementById('syntax-highlight');
            if (highlightDiv) {
                highlightDiv.innerHTML = '';
                highlightDiv.style.display = 'none';
            }
        }

        function applySyntaxHighlighting(filename) {
            const editor = document.getElementById('code-editor');
            const highlightDiv = document.getElementById('syntax-highlight');
            
            if (!editor || !highlightDiv) {
                console.log('–†–µ–¥–∞–∫—Ç–æ—Ä –∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
            resetSyntaxHighlighting();

            const ext = filename.split('.').pop().toLowerCase();
            const content = editor.value;
            
            console.log('–ü–û–î–°–í–ï–¢–ö–ê –û–¢–ö–õ–Æ–ß–ï–ù–ê –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', filename, '—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ:', ext);
            
            // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ê–ï–ú –ü–û–î–°–í–ï–¢–ö–£ –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
            return;
            
            // –°–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç–æ—è—â—É—é HTML –ø–æ–¥—Å–≤–µ—Ç–∫—É
            let highlightedContent = content;
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–ª—è PLC - –ù–û–í–´–ô –ü–û–î–•–û–î
            if (ext === 'plc') {
                // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
                let lines = highlightedContent.split('\n');
                let result = [];
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    
                    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
                    line = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
                    line = line
                        .replace(/\b(IF|THEN|ELSE|END_IF|WHILE|DO|END_WHILE|FOR|TO|BY|END_FOR|CASE|OF|END_CASE|FUNCTION|END_FUNCTION|PROGRAM|END_PROGRAM|VAR|END_VAR|CONSTANT|TYPE|END_TYPE|STRUCT|END_STRUCT|ENUM|END_ENUM)\b/gi, '<span style="color: #569cd6; font-weight: bold;">$1</span>')
                        .replace(/\b(TRUE|FALSE|BOOL|INT|DINT|REAL|STRING|TIME|DATE|DT)\b/gi, '<span style="color: #569cd6; font-weight: bold;">$1</span>')
                        .replace(/\b(AND|OR|NOT|XOR|MOD|DIV|SHR|SHL|ROL|ROR)\b/gi, '<span style="color: #569cd6; font-weight: bold;">$1</span>')
                        .replace(/\b(I[0-9]+\.?[0-9]*|Q[0-9]+\.?[0-9]*|M[0-9]+\.?[0-9]*|DB[0-9]+\.DB[XY][0-9]+\.?[0-9]*)\b/gi, '<span style="color: #d7ba7d; font-weight: bold;">$1</span>')
                        .replace(/\b(TON|TOF|TP|CTU|CTD|CTUD|TONR|TOFR|TPR)\b/gi, '<span style="color: #4ec9b0; font-weight: bold;">$1</span>')
                        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏–π —Å ERROR –∏–ª–∏ STOP –∫—Ä–∞—Å–Ω—ã–º
                        .replace(/\b[A-Z_]*ERROR[A-Z_]*\b/gi, '<span style="color: #f44747; font-weight: bold;">$&</span>')
                        .replace(/\b[A-Z_]*STOP[A-Z_]*\b/gi, '<span style="color: #f44747; font-weight: bold;">$&</span>')
                        .replace(/\b[A-Z_]*FAULT[A-Z_]*\b/gi, '<span style="color: #f44747; font-weight: bold;">$&</span>')
                        .replace(/\b[A-Z_]*ALARM[A-Z_]*\b/gi, '<span style="color: #f44747; font-weight: bold;">$&</span>')
                        // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∑–µ–ª–µ–Ω—ã–º
                        .replace(/\/\/.*$/gm, '<span style="color: #6a9955; font-style: italic;">$&</span>')
                        .replace(/;.*$/gm, '<span style="color: #6a9955; font-style: italic;">$&</span>')
                        .replace(/\b[0-9]+\.[0-9]+\b/g, '<span style="color: #d7ba7d; font-weight: bold;">$&</span>')
                        .replace(/\b[0-9]+\b/g, '<span style="color: #d7ba7d; font-weight: bold;">$&</span>');
                    
                    result.push(line);
                }
                
                highlightedContent = result.join('\n');
            }
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (–ø–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤):', highlightedContent.substring(0, 300));
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            highlightDiv.innerHTML = highlightedContent;
            highlightDiv.style.display = 'block';
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å—Ç–∏–ª–∏
            const editorStyle = window.getComputedStyle(editor);
            highlightDiv.style.fontFamily = editorStyle.fontFamily;
            highlightDiv.style.fontSize = editorStyle.fontSize;
            highlightDiv.style.lineHeight = editorStyle.lineHeight;
            highlightDiv.style.padding = editorStyle.padding;
            highlightDiv.style.margin = editorStyle.margin;
            highlightDiv.style.border = editorStyle.border;
            highlightDiv.style.boxSizing = editorStyle.boxSizing;
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
            function syncScroll() {
                highlightDiv.scrollTop = editor.scrollTop;
                highlightDiv.scrollLeft = editor.scrollLeft;
            }
            
            function updateHighlight() {
                const currentContent = editor.value;
                if (currentContent !== content) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å –Ω–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
                    applySyntaxHighlighting(filename);
                }
            }
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            editor.removeEventListener('scroll', syncScroll);
            editor.removeEventListener('input', updateHighlight);
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            editor.addEventListener('scroll', syncScroll);
            editor.addEventListener('input', updateHighlight);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            syncScroll();
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            setTimeout(() => {
                syncScroll();
            }, 100);
            
            console.log('–ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∞—è —Ü–≤–µ—Ç–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
        }

        function highlightPLC(content) {
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
            content = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            return content
                .replace(/\b(IF|THEN|ELSE|END_IF|WHILE|DO|END_WHILE|FOR|TO|BY|END_FOR|CASE|OF|END_CASE|FUNCTION|END_FUNCTION|PROGRAM|END_PROGRAM|VAR|END_VAR|CONSTANT|TYPE|END_TYPE|STRUCT|END_STRUCT|ENUM|END_ENUM)\b/gi, '<span class="plc-keyword">$1</span>')
                .replace(/\b(TRUE|FALSE|BOOL|INT|DINT|REAL|STRING|TIME|DATE|DT)\b/gi, '<span class="plc-keyword">$1</span>')
                .replace(/\b(AND|OR|NOT|XOR|MOD|DIV|SHR|SHL|ROL|ROR)\b/gi, '<span class="operator">$1</span>')
                .replace(/\b(I[0-9]+\.?[0-9]*|Q[0-9]+\.?[0-9]*|M[0-9]+\.?[0-9]*|DB[0-9]+\.DB[XY][0-9]+\.?[0-9]*)\b/gi, '<span class="plc-address">$1</span>')
                .replace(/\b(TON|TOF|TP|CTU|CTD|CTUD|TONR|TOFR|TPR)\b/gi, '<span class="plc-function">$1</span>')
                .replace(/\/\*[\s\S]*?\*\//g, '<span class="comment">$&</span>')
                .replace(/\/\/.*$/gm, '<span class="comment">$&</span>')
                .replace(/"([^"\\]|\\.)*"/g, '<span class="string">$&</span>')
                .replace(/'([^'\\]|\\.)*'/g, '<span class="string">$&</span>')
                .replace(/\b[0-9]+\.[0-9]+\b/g, '<span class="number">$&</span>')
                .replace(/\b[0-9]+\b/g, '<span class="number">$&</span>');
        }

        function highlightPython(content) {
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
            content = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            return content
                .replace(/\b(def|class|if|elif|else|for|while|try|except|finally|with|import|from|as|return|yield|lambda|and|or|not|in|is|True|False|None)\b/g, '<span class="keyword">$1</span>')
                .replace(/\b([A-Za-z_][A-Za-z0-9_]*)\s*\(/g, '<span class="function">$1</span>(')
                .replace(/#.*$/gm, '<span class="comment">$&</span>')
                .replace(/"""[\s\S]*?"""/g, '<span class="comment">$&</span>')
                .replace(/'''[\s\S]*?'''/g, '<span class="comment">$&</span>')
                .replace(/"[^"]*"/g, '<span class="string">$&</span>')
                .replace(/'[^']*'/g, '<span class="string">$&</span>')
                .replace(/\b[0-9]+\.[0-9]+\b/g, '<span class="number">$&</span>')
                .replace(/\b[0-9]+\b/g, '<span class="number">$&</span>');
        }

        function highlightJavaScript(content) {
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
            content = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            return content
                .replace(/\b(function|var|let|const|if|else|for|while|do|switch|case|break|continue|return|try|catch|finally|throw|new|this|class|extends|import|export|async|await)\b/g, '<span class="keyword">$1</span>')
                .replace(/\b([A-Za-z_][A-Za-z0-9_]*)\s*\(/g, '<span class="function">$1</span>(')
                .replace(/\/\/.*$/gm, '<span class="comment">$&</span>')
                .replace(/\/\*[\s\S]*?\*\//g, '<span class="comment">$&</span>')
                .replace(/"[^"]*"/g, '<span class="string">$&</span>')
                .replace(/'[^']*'/g, '<span class="string">$&</span>')
                .replace(/`[^`]*`/g, '<span class="string">$&</span>')
                .replace(/\b[0-9]+\.[0-9]+\b/g, '<span class="number">$&</span>')
                .replace(/\b[0-9]+\b/g, '<span class="number">$&</span>');
        }

        function highlightHTML(content) {
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
            content = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            return content
                .replace(/&lt;\/?[^&gt;]+&gt;/g, '<span class="keyword">$&</span>')
                .replace(/&lt;!--[\s\S]*?--&gt;/g, '<span class="comment">$&</span>')
                .replace(/"[^"]*"/g, '<span class="string">$&</span>')
                .replace(/'[^']*'/g, '<span class="string">$&</span>');
        }

        function highlightCSS(content) {
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
            content = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            return content
                .replace(/\b([A-Za-z-]+)\s*:/g, '<span class="keyword">$1</span>:')
                .replace(/\/\*[\s\S]*?\*\//g, '<span class="comment">$&</span>')
                .replace(/"[^"]*"/g, '<span class="string">$&</span>')
                .replace(/'[^']*'/g, '<span class="string">$&</span>')
                .replace(/\b[0-9]+(px|em|rem|%|vh|vw|pt|pc|in|cm|mm)\b/g, '<span class="number">$&</span>');
        }

        function highlightXML(content) {
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
            content = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            return content
                .replace(/&lt;\/?[^&gt;]+&gt;/g, '<span class="keyword">$&</span>')
                .replace(/&lt;!--[\s\S]*?--&gt;/g, '<span class="comment">$&</span>')
                .replace(/"[^"]*"/g, '<span class="string">$&</span>')
                .replace(/'[^']*'/g, '<span class="string">$&</span>');
        }

        function highlightGeneric(content) {
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Å–∏–º–≤–æ–ª—ã
            content = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            return content
                .replace(/\/\/.*$/gm, '<span class="comment">$&</span>')
                .replace(/\/\*[\s\S]*?\*\//g, '<span class="comment">$&</span>')
                .replace(/"[^"]*"/g, '<span class="string">$&</span>')
                .replace(/'[^']*'/g, '<span class="string">$&</span>')
                .replace(/\b[0-9]+\.[0-9]+\b/g, '<span class="number">$&</span>')
                .replace(/\b[0-9]+\b/g, '<span class="number">$&</span>');
        }

        // –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
        function analyzeCurrentFile() {
            const editor = document.getElementById('code-editor');
            if (!editor || !editor.value.trim()) {
                appendChatMessage('error', '‚ùå –ù–µ—Ç —Ñ–∞–π–ª–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ.');
                return;
            }

            const content = editor.value;
            const filename = getCurrentFileName();
            const ext = filename.split('.').pop().toLowerCase();
            
            appendChatMessage('user', `üîç –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞: ${filename}`);
            
            // –ê–Ω–∞–ª–∏–∑ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            let analysis = '';
            
            switch (ext) {
                case 'plc':
                    analysis = analyzePLCFile(content, filename);
                    break;
                case 'py':
                    analysis = analyzePythonFile(content, filename);
                    break;
                case 'js':
                    analysis = analyzeJavaScriptFile(content, filename);
                    break;
                case 'html':
                    analysis = analyzeHTMLFile(content, filename);
                    break;
                case 'xml':
                    analysis = analyzeXMLFile(content, filename);
                    break;
                default:
                    analysis = analyzeGenericFile(content, filename);
            }
            
            appendChatMessage('ai', analysis);
        }

        function getCurrentFileName() {
            const statusBar = document.querySelector('.project-info');
            if (statusBar) {
                const text = statusBar.textContent;
                const match = text.match(/üìÑ\s+([^|]+)/);
                if (match) {
                    return match[1].trim();
                }
            }
            return 'unknown.txt';
        }

        function analyzePLCFile(content, filename) {
            const lines = content.split('\n');
            const totalLines = lines.length;
            const totalChars = content.length;
            
            // –ü–æ–∏—Å–∫ –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const programs = content.match(/PROGRAM\s+(\w+)/gi) || [];
            const functions = content.match(/FUNCTION\s+(\w+)/gi) || [];
            const variables = content.match(/VAR\s+([\s\S]*?)END_VAR/gi) || [];
            const comments = content.match(/\/\/.*$/gm) || [];
            const addresses = content.match(/\b[IQM]\d+\.\d+\b/g) || [];
            const timers = content.match(/\b(TON|TOF|TP|CTU|CTD|CTUD)\b/gi) || [];
            
            // –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
            let analysis = `üìä **–ê–ù–ê–õ–ò–ó PLC –§–ê–ô–õ–ê: ${filename}**\n\n`;
            analysis += `üìà **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n`;
            analysis += `‚Ä¢ –°—Ç—Ä–æ–∫ –∫–æ–¥–∞: ${totalLines}\n`;
            analysis += `‚Ä¢ –°–∏–º–≤–æ–ª–æ–≤: ${totalChars}\n`;
            analysis += `‚Ä¢ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${comments.length}\n\n`;
            
            analysis += `üèóÔ∏è **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã:**\n`;
            analysis += `‚Ä¢ –ü—Ä–æ–≥—Ä–∞–º–º: ${programs.length}\n`;
            analysis += `‚Ä¢ –§—É–Ω–∫—Ü–∏–π: ${functions.length}\n`;
            analysis += `‚Ä¢ –ë–ª–æ–∫–æ–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: ${variables.length}\n\n`;
            
            analysis += `‚öôÔ∏è **–≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**\n`;
            analysis += `‚Ä¢ –ê–¥—Ä–µ—Å–æ–≤ I/O: ${addresses.length}\n`;
            analysis += `‚Ä¢ –¢–∞–π–º–µ—Ä–æ–≤/—Å—á–µ—Ç—á–∏–∫–æ–≤: ${timers.length}\n\n`;
            
            if (programs.length > 0) {
                analysis += `üìã **–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:**\n`;
                programs.forEach((prog, i) => {
                    analysis += `${i + 1}. ${prog}\n`;
                });
                analysis += `\n`;
            }
            
            if (functions.length > 0) {
                analysis += `üîß **–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**\n`;
                functions.forEach((func, i) => {
                    analysis += `${i + 1}. ${func}\n`;
                });
                analysis += `\n`;
            }
            
            // –ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            const complexity = calculateComplexity(content);
            analysis += `üìä **–ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:**\n`;
            analysis += `‚Ä¢ –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: ${complexity.level}\n`;
            analysis += `‚Ä¢ –û—Ü–µ–Ω–∫–∞: ${complexity.score}/10\n`;
            analysis += `‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: ${complexity.recommendations}\n\n`;
            
            analysis += `üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**\n`;
            if (comments.length < totalLines * 0.1) {
                analysis += `‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (—Å–µ–π—á–∞—Å ${(comments.length/totalLines*100).toFixed(1)}%)\n`;
            }
            if (functions.length === 0) {
                analysis += `‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\n`;
            }
            if (addresses.length > 50) {
                analysis += `‚Ä¢ –ú–Ω–æ–≥–æ I/O –∞–¥—Ä–µ—Å–æ–≤ (${addresses.length}) - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é\n`;
            }
            
            return analysis;
        }

        function analyzePythonFile(content, filename) {
            const lines = content.split('\n');
            const totalLines = lines.length;
            const totalChars = content.length;
            
            const functions = content.match(/def\s+(\w+)/g) || [];
            const classes = content.match(/class\s+(\w+)/g) || [];
            const imports = content.match(/import\s+(\w+)/g) || [];
            const comments = content.match(/#.*$/gm) || [];
            
            let analysis = `üìä **–ê–ù–ê–õ–ò–ó PYTHON –§–ê–ô–õ–ê: ${filename}**\n\n`;
            analysis += `üìà **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n`;
            analysis += `‚Ä¢ –°—Ç—Ä–æ–∫ –∫–æ–¥–∞: ${totalLines}\n`;
            analysis += `‚Ä¢ –°–∏–º–≤–æ–ª–æ–≤: ${totalChars}\n`;
            analysis += `‚Ä¢ –§—É–Ω–∫—Ü–∏–π: ${functions.length}\n`;
            analysis += `‚Ä¢ –ö–ª–∞—Å—Å–æ–≤: ${classes.length}\n`;
            analysis += `‚Ä¢ –ò–º–ø–æ—Ä—Ç–æ–≤: ${imports.length}\n`;
            analysis += `‚Ä¢ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${comments.length}\n\n`;
            
            if (functions.length > 0) {
                analysis += `üîß **–§—É–Ω–∫—Ü–∏–∏:**\n`;
                functions.forEach((func, i) => {
                    analysis += `${i + 1}. ${func}\n`;
                });
                analysis += `\n`;
            }
            
            if (classes.length > 0) {
                analysis += `üèóÔ∏è **–ö–ª–∞—Å—Å—ã:**\n`;
                classes.forEach((cls, i) => {
                    analysis += `${i + 1}. ${cls}\n`;
                });
                analysis += `\n`;
            }
            
            return analysis;
        }

        function analyzeJavaScriptFile(content, filename) {
            const lines = content.split('\n');
            const totalLines = lines.length;
            const totalChars = content.length;
            
            const functions = content.match(/function\s+(\w+)/g) || [];
            const variables = content.match(/(var|let|const)\s+(\w+)/g) || [];
            const comments = content.match(/\/\/.*$/gm) || [];
            
            let analysis = `üìä **–ê–ù–ê–õ–ò–ó JAVASCRIPT –§–ê–ô–õ–ê: ${filename}**\n\n`;
            analysis += `üìà **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n`;
            analysis += `‚Ä¢ –°—Ç—Ä–æ–∫ –∫–æ–¥–∞: ${totalLines}\n`;
            analysis += `‚Ä¢ –°–∏–º–≤–æ–ª–æ–≤: ${totalChars}\n`;
            analysis += `‚Ä¢ –§—É–Ω–∫—Ü–∏–π: ${functions.length}\n`;
            analysis += `‚Ä¢ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: ${variables.length}\n`;
            analysis += `‚Ä¢ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${comments.length}\n\n`;
            
            return analysis;
        }

        function analyzeHTMLFile(content, filename) {
            const lines = content.split('\n');
            const totalLines = lines.length;
            const totalChars = content.length;
            
            const tags = content.match(/<(\w+)/g) || [];
            const scripts = content.match(/<script/g) || [];
            const styles = content.match(/<style/g) || [];
            
            let analysis = `üìä **–ê–ù–ê–õ–ò–ó HTML –§–ê–ô–õ–ê: ${filename}**\n\n`;
            analysis += `üìà **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n`;
            analysis += `‚Ä¢ –°—Ç—Ä–æ–∫ –∫–æ–¥–∞: ${totalLines}\n`;
            analysis += `‚Ä¢ –°–∏–º–≤–æ–ª–æ–≤: ${totalChars}\n`;
            analysis += `‚Ä¢ HTML —Ç–µ–≥–æ–≤: ${tags.length}\n`;
            analysis += `‚Ä¢ Script –±–ª–æ–∫–æ–≤: ${scripts.length}\n`;
            analysis += `‚Ä¢ Style –±–ª–æ–∫–æ–≤: ${styles.length}\n\n`;
            
            return analysis;
        }

        function analyzeXMLFile(content, filename) {
            const lines = content.split('\n');
            const totalLines = lines.length;
            const totalChars = content.length;
            
            const elements = content.match(/<(\w+)/g) || [];
            const attributes = content.match(/\w+\s*=/g) || [];
            
            let analysis = `üìä **–ê–ù–ê–õ–ò–ó XML –§–ê–ô–õ–ê: ${filename}**\n\n`;
            analysis += `üìà **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n`;
            analysis += `‚Ä¢ –°—Ç—Ä–æ–∫ –∫–æ–¥–∞: ${totalLines}\n`;
            analysis += `‚Ä¢ –°–∏–º–≤–æ–ª–æ–≤: ${totalChars}\n`;
            analysis += `‚Ä¢ XML —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${elements.length}\n`;
            analysis += `‚Ä¢ –ê—Ç—Ä–∏–±—É—Ç–æ–≤: ${attributes.length}\n\n`;
            
            return analysis;
        }

        function analyzeGenericFile(content, filename) {
            const lines = content.split('\n');
            const totalLines = lines.length;
            const totalChars = content.length;
            
            let analysis = `üìä **–ê–ù–ê–õ–ò–ó –§–ê–ô–õ–ê: ${filename}**\n\n`;
            analysis += `üìà **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n`;
            analysis += `‚Ä¢ –°—Ç—Ä–æ–∫: ${totalLines}\n`;
            analysis += `‚Ä¢ –°–∏–º–≤–æ–ª–æ–≤: ${totalChars}\n`;
            analysis += `‚Ä¢ –°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏: ${Math.round(totalChars / totalLines)}\n\n`;
            
            return analysis;
        }

        function calculateComplexity(content) {
            const lines = content.split('\n');
            const totalLines = lines.length;
            
            // –ü–æ–¥—Å—á–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
            let maxNesting = 0;
            let currentNesting = 0;
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.includes('IF') || trimmed.includes('WHILE') || trimmed.includes('FOR')) {
                    currentNesting++;
                    maxNesting = Math.max(maxNesting, currentNesting);
                }
                if (trimmed.includes('END_IF') || trimmed.includes('END_WHILE') || trimmed.includes('END_FOR')) {
                    currentNesting--;
                }
            }
            
            // –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            let score = 5; // –±–∞–∑–æ–≤–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å
            if (maxNesting > 3) score += 2;
            if (totalLines > 500) score += 2;
            if (totalLines > 1000) score += 1;
            
            let level = '–ù–∏–∑–∫–∞—è';
            if (score > 7) level = '–í—ã—Å–æ–∫–∞—è';
            else if (score > 5) level = '–°—Ä–µ–¥–Ω—è—è';
            
            let recommendations = '';
            if (maxNesting > 3) recommendations += '–£–ø—Ä–æ—Å—Ç–∏—Ç–µ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å —É—Å–ª–æ–≤–∏–π. ';
            if (totalLines > 500) recommendations += '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –º–æ–¥—É–ª–∏. ';
            if (recommendations === '') recommendations = '–ö–æ–¥ —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω.';
            
            return { level, score, recommendations };
        }

    </script>
</body>
</html>